<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>APK Store</title>
  <meta name="description" content="APK Store — UI ala Play Store: banner populer, kategori per-row, detail + rating & ulasan realtime (1 user 1 ulasan), whitelist & votes ulasan." />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#1a73e8;
      --brand2:#0b57d0;
      --good:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --star:#fbbf24;
      --starOff:#cbd5e1;
      --shadow: 0 10px 25px rgba(15, 23, 42, .07);
      --shadow2: 0 18px 60px rgba(2,6,23,.14);
      --safeT: env(safe-area-inset-top);
      --safeB: env(safe-area-inset-bottom);
      --safeL: env(safe-area-inset-left);
      --safeR: env(safe-area-inset-right);
      --navH: 72px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{overflow-x:clip}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }
    a{color:inherit;text-decoration:none}
    button, input, textarea, select{font:inherit}

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px;
      padding-left: calc(14px + var(--safeL));
      padding-right: calc(14px + var(--safeR));
    }

    /* ===== Header ===== */
    .header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(246,247,251,.86);
      backdrop-filter: none;
      border-bottom: 1px solid rgba(229,231,235,.7);
    }
    .header-inner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 10px 14px 10px;
      padding-top: calc(10px + var(--safeT));
      padding-left: calc(14px + var(--safeL));
      padding-right: calc(14px + var(--safeR));
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand .mark{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      display:grid;place-items:center;
      box-shadow: 0 10px 20px rgba(26,115,232,.2);
      flex:0 0 auto;
    }
    .brand .title{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .auth{display:flex;align-items:center;gap:8px;flex:0 0 auto;}
    .btnAuth{
      height:38px;border-radius:999px;padding:0 12px;
      border:1px solid var(--line);background:var(--card);
      color:var(--text);font-size:13px;font-weight:900;
      cursor:pointer;min-height:44px;
    }
    .btnAuth.primary{
      background:var(--brand);border-color:transparent;color:#fff;
      box-shadow: 0 10px 18px rgba(26,115,232,.18);
    }
    .btnAuth:active{transform:scale(.99)}

    /* avatar-only in header */
    .avatarBtn{
      width:40px;height:40px;border-radius:999px;
      border:1px solid var(--line);background:#fff;
      display:none;place-items:center;cursor:pointer;padding:0;
            box-shadow: 0 6px 14px rgba(15,23,42,.06);
      overflow:hidden;
    }
    .avatarBtn img{width:100%;height:100%;object-fit:cover;display:block;}
    .avatarBtn:active{transform:scale(.99)}

    /* Search + tabs (hidden on profile) */
    .headerExtras{display:grid;gap:10px;}
    .headerExtras.hidden{display:none;}

    .searchBar{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .searchBar svg{flex:0 0 auto;opacity:.75}
    .searchBar input{
      width:100%;
      border:none;outline:none;background:transparent;
      font-size:16px; /* iOS anti-zoom */
    }
    .pill{font-size:12px;font-weight:900;color:var(--muted);white-space:nowrap;}

    .tabs{
      display:flex;gap:14px;align-items:flex-end;overflow:auto;scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      position:relative;padding:8px 2px;
      font-weight:1000;color:var(--muted);
      cursor:pointer;user-select:none;white-space:nowrap;
    }
    .tab.active{color:var(--text)}
    .tab.active:after{
      content:"";position:absolute;left:0;right:0;bottom:0;
      height:3px;border-radius:999px;background:var(--brand);
    }

    /* ===== Bottom nav ===== */
    .bottomNav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 40;
      background: rgba(246,247,251,.90);
      backdrop-filter: none;
      border-top: 1px solid rgba(229,231,235,.75);
      padding-bottom: var(--safeB);
      transition: transform .18s ease, opacity .18s ease;
    }
    body.kbd .bottomNav{
      transform: translateY(120%);
      opacity: 0;
      pointer-events: none;
    }
    .bottomNav-inner{
      max-width: 1120px;margin: 0 auto;
      padding: 8px 14px;
      padding-left: calc(14px + var(--safeL));
      padding-right: calc(14px + var(--safeR));
      display:grid;grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      min-height: var(--navH);
    }
    .navBtn{
      border:none;background:transparent;border-radius: 14px;
      padding: 8px 6px;cursor:pointer;
      display:flex;flex-direction:column;gap:4px;
      align-items:center;justify-content:center;
      color: var(--muted);
      font-weight:900;font-size:11px;
      min-height: 44px;
    }
    .navBtn.active{color: var(--brand2);background: rgba(26,115,232,.10);}
    .navBtn:active{transform:scale(.99)}
    .navBtn svg{width:20px;height:20px}

    /* ===== Content ===== */
    .content{
      min-height: calc(100vh - 210px);
      padding-bottom: calc(var(--navH) + 20px + var(--safeB));
    }
    .state{
      padding: 14px;border: 1px dashed rgba(100,116,139,.35);
      border-radius: 16px;color: var(--muted);
      background: rgba(255,255,255,.6);text-align:center;
    }

    .section{ margin-top: 14px; }
    .sectionHead{
      display:flex;align-items:center;justify-content:flex-start;
      gap:10px;margin-bottom: 10px;
    }
    .sectionTitle{ font-weight:1000;font-size:15px; }
    .sectionLink{
      border:none;background:transparent;
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 6px;border-radius: 14px;
      cursor:pointer;min-height:44px;
    }
    .sectionLink:hover{background: rgba(2,6,23,.03)}
    .chevMini{
      opacity:.65;display:inline-flex;align-items:center;
      font-size:16px;line-height:1;
      transform: translateY(1px);
    }
    .chevMini svg{width:16px;height:16px}

    .linkBtn{
      border:none;background:transparent;cursor:pointer;
      font-weight:1000;font-size:13px;color:var(--brand2);
      padding: 6px 10px;border-radius: 999px;min-height:44px;
    }
    .linkBtn:hover{background: rgba(26,115,232,.08)}
    .linkBtn:active{transform:scale(.99)}

    

    .arrowBtn{
      width:32px;height:32px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      cursor:pointer;
      display:grid;place-items:center;
            box-shadow: 0 6px 14px rgba(15,23,42,.06);
      padding:0;
      flex:0 0 auto;
    }
    .arrowBtn svg{width:20px;height:20px}
    .arrowBtn:hover{background: rgba(26,115,232,.06)}
    .arrowBtn:active{transform:scale(.99)}

    .btn.dangerSolid{
      background: var(--danger);
      border-color: transparent;
      color: #fff;
      box-shadow: 0 10px 18px rgba(239,68,68,.18);
    }
/* Banner carousel */
    .bannerRow{
      display:flex;gap:12px;overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 8px;
      scroll-snap-type: x proximity;
    }
    .banner{
      scroll-snap-align:start;
      flex:0 0 auto;
      width: min(560px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(229,231,235,.8);
      background: #fff;
      box-shadow: var(--shadow2);
      overflow:hidden;
      cursor:pointer;
      position:relative;
      min-height: 168px;
    }
    .banner:active{transform:scale(.995)}
    .bannerBg{
      position:absolute;inset:0;
      background: linear-gradient(135deg, rgba(26,115,232,.14), rgba(11,87,208,.06));
    }
    .bannerImg{
      position:absolute;inset:0;
      width:100%;height:100%;
      object-fit:cover;
      opacity:.18;
      filter: blur(1px);
      transform: scale(1.05);
    }
    .bannerInner{
      position:relative;
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .bannerIco{
      width:64px;height:64px;border-radius: 18px;
      border:1px solid rgba(229,231,235,.9);
      background:#fff;
      object-fit:cover;
      flex:0 0 auto;
      box-shadow: 0 12px 22px rgba(2,6,23,.12);
    }
    .bannerMain{min-width:0;flex:1}
    .bannerTitle{
      margin:0;
      font-weight:1000;
      font-size: 18px;
      line-height:1.15;
      letter-spacing:.1px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .bannerDesc{
      margin-top:6px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .bannerMeta{
      margin-top:10px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
    }
    .bannerCta{
      height:40px;border-radius:999px;
      padding:0 14px;border:1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.92);
      font-weight:1000;
      cursor:pointer;
      min-height:44px;
    }
    .bannerCta:active{transform:scale(.99)}

    .hscroll{
      display:flex;gap: 10px;overflow:auto;
      padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
    }
    .tile{
      scroll-snap-align: start;
      min-width: 220px;max-width: 220px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 12px;
      cursor:pointer;
      display:flex;gap: 10px;align-items:flex-start;
    }
    .tile:active{transform:scale(.995)}
    .ico{
      width: 56px; height:56px;border-radius: 16px;
      border: 1px solid var(--line);
      object-fit:cover;background:#fff;flex:0 0 auto;
    }
    .tileMain{min-width:0; flex:1}
    .tileName{
      font-weight:1000;font-size:14px;line-height:1.25;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;margin:0;
    }
    .tileMeta{
      margin-top:6px;display:flex;flex-wrap:wrap;
      gap: 8px;align-items:center;
      color: var(--muted);font-size:12px;
    }

    /* Vertical list (Top/search) */
    .vlist{display:grid;grid-template-columns: 1fr;gap: 10px;}
    .rowCard{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 12px;
      cursor:pointer;
      display:grid;
      grid-template-columns: 56px minmax(0, 1fr) auto;
      gap: 12px;
      align-items:center;
    }
    .rowMain{min-width:0; flex:1}
    .rowTitle{
      display:flex;justify-content:space-between;
      gap:10px;align-items:flex-start;
    }
    .rowName{
      font-weight:1000;font-size:15px;margin:0;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .badge{
      font-size:11px;padding:4px 8px;border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;color: var(--muted);
      font-weight:1000;white-space:nowrap;
    }
    .badge.new{border-color:rgba(16,185,129,.4); background:rgba(16,185,129,.08); color:var(--good);}
    .badge.mod{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.10); color:var(--warn);}
    .rowDesc{
      margin-top:6px;color: var(--muted);
      font-size:13px;line-height:1.4;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;
    }
    .rowMeta{
      margin-top:8px;display:flex;flex-wrap:wrap;
      gap: 10px 12px;align-items:center;
      color: var(--muted);font-size:12px;
    }
    .btnInstall{
      height: 40px;border-radius: 999px;padding: 0 14px;
      border: 1px solid var(--line);
      background: var(--brand);color:#fff;
      font-weight:1000;cursor:pointer;
      box-shadow: 0 10px 18px rgba(26,115,232,.16);
      white-space:nowrap;flex:0 0 auto;
      min-height: 44px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btnInstall:active{transform:scale(.99)}
    .btnInstall svg{width:18px;height:18px}

    /* Stars */
    .stars{display:inline-flex;gap:2px;align-items:center;transform: translateY(1px)}
    .stars svg{width:13px;height:13px}
    .on{fill: var(--star)}
    .off{fill: var(--starOff)}
    .ratingNum{font-weight:1000;color: var(--text)}

    /* ===== Modal ===== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.56);
      display:none;z-index: 200;
      padding: 14px;
      padding-bottom: calc(14px + var(--safeB));
      padding-left: calc(14px + var(--safeL));
      padding-right: calc(14px + var(--safeR));
      overflow:auto;-webkit-overflow-scrolling: touch;
          opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease;
    }
    .overlay.show{display:block; opacity:1; pointer-events:auto}
        .overlay.dialog{z-index: 300;}
.modal{
      width: min(960px, 100%);
      margin: 32px auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 22px;
      box-shadow: 0 18px 48px rgba(2,6,23,.28);
      overflow:hidden;
    }
    .modalTop{
      padding: 12px 14px;border-bottom: 1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;
    }
    .modalTitle{
      font-weight:1000;font-size:14px;color: var(--muted);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      min-width:0;
    }
    .xbtn{
      width: 42px; height: 42px;border-radius: 14px;
      border: 1px solid var(--line);background:#fff;
      cursor:pointer;display:grid;place-items:center;
      box-shadow: 0 10px 20px rgba(15,23,42,.06);
      min-height:44px;
    }
    .xbtn:active{transform:scale(.99)}
    .modalBody{
      padding: 14px;display:grid;gap: 14px;
      max-height: calc(100dvh - 140px);
      overflow:auto;-webkit-overflow-scrolling: touch;
    }
    @supports not (height: 100dvh){
      .modalBody{max-height: calc(100vh - 140px)}
    }

    .hero{ display:flex; gap: 14px; align-items:flex-start; }
    .hero .ico{ width: 86px; height: 86px; border-radius: 22px; }
    .hero h2{ margin:0; font-size: 20px; line-height:1.15; font-weight: 1000; }
    .heroSmall{
      margin-top: 8px;color: var(--muted);
      display:flex;flex-wrap:wrap;gap: 10px;align-items:center;
      font-size: 13px;
    }
    .actions{
      display:flex;gap: 10px;flex-wrap:wrap;align-items:center;
      margin-top: 12px;
    }
    .btn{
      height: 42px;padding: 0 14px;border-radius: 999px;
      border: 1px solid var(--line);background:#fff;
      cursor:pointer;font-weight: 1000;font-size: 13px;
      min-height:44px;
      display:inline-flex;align-items:center;gap:8px;
    }

    .selectPill{
      height: 40px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      padding: 0 36px 0 14px;
      cursor: pointer;
      font-weight: 1000;
      font-size: 13px;
      color: var(--text);
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px 16px;
    }
    .selectPill:focus{
      border-color: rgba(26,115,232,.45);
      box-shadow: 0 0 0 4px rgba(26,115,232,.10);
    }

    .btn svg{width:18px;height:18px}
    .btn.primary{
      background: var(--brand);border-color: transparent;color:#fff;
      box-shadow: 0 10px 18px rgba(26,115,232,.18);
      text-decoration:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.ghost{
      background: rgba(255,255,255,.92);
    }
    .btn.wl.on{
      border-color: rgba(26,115,232,.45);
      box-shadow: 0 0 0 4px rgba(26,115,232,.10);
    }

    .kv{
      display:grid;grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    .kv .box{
      border: 1px solid var(--line);
      border-radius: 16px;padding: 10px 12px;
      background: rgba(255,255,255,.8);
    }
    .kv .k{color:var(--muted); font-size:12px}
    .kv .v{margin-top:4px; font-weight:1000; font-size:14px}

    .panel{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.8);
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;
      gap: 10px;margin-bottom: 10px;
    }
    .panelHead h3{ margin:0;font-size: 14px;font-weight: 1000; }
    .panel p{
      margin:0;color: var(--muted);
      font-size: 13px;line-height: 1.55;
      white-space: pre-wrap;
    }

    .shots{
      display:flex;gap: 10px;overflow:auto;padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
    }
    .shot{
      width: 190px; height: 118px;border-radius: 16px;
      border: 1px solid var(--line);
      object-fit: cover;background:#fff;
      scroll-snap-align: start;flex:0 0 auto;
    }

    /* Reviews */
    .reviewSummary{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      color: var(--muted);font-size: 13px;
    }
    .reviewGrid{
      display:grid;grid-template-columns: 1fr;
      gap: 12px;margin-top: 10px;
    }
    .reviewStats{
      display:grid;grid-template-columns: 120px 1fr;
      gap: 12px;align-items:center;
    }
    .bigRating{
      display:flex;flex-direction:column;gap: 6px;align-items:flex-start;
    }
    .bigRating .num{font-size:36px;font-weight:1000;line-height:1}
    .bars{display:grid;gap: 6px;}
    .barRow{
      display:grid;grid-template-columns: 20px 1fr 34px;
      gap: 8px;align-items:center;
      color: var(--muted);font-size: 12px;
      padding: 6px 8px;
      border-radius: 12px;
      cursor: pointer;
      user-select:none;
    }
    .barRow:hover{ background: rgba(2,6,23,.03); }
    .barRow.active{
      background: rgba(26,115,232,.10);
      color: var(--brand2);
    }
    .bar{
      height: 8px;border-radius: 999px;
      background: rgba(100,116,139,.18);
      overflow:hidden;position:relative;
    }
    .bar > span{
      position:absolute;left:0;top:0;bottom:0;
      width: 0%;
      background: var(--brand);
      border-radius: 999px;
      transition: width .18s ease;
    }

    /* My review compact card */
    .myReviewCard{
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      padding: 10px 12px;
    }
    .myReviewTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .myReviewTop .t{
      font-weight:1000;font-size:13px;color:var(--text);
    }
    .iconBtn{
      width: 42px;height:42px;border-radius: 14px;
      border: 1px solid rgba(229,231,235,.9);
      background:#fff;
      display:grid;place-items:center;
      cursor:pointer;
      min-height:44px;
    }
    .iconBtn:active{transform:scale(.99)}
    .iconBtn svg{width:18px;height:18px}
    .myReviewMeta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .myReviewText{margin-top:6px;color:var(--text);font-size:13px;line-height:1.45;white-space:pre-wrap;word-break:break-word;}
    .myReviewEmpty{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.45;}
    .editor{display:none;margin-top:10px;}
    .editor.show{display:block;}

    .rateStars{
      display:flex;gap: 6px;flex-wrap:wrap;align-items:center;
    }
    .starBtn{
      border:none;background:transparent;padding: 6px;border-radius: 14px;
      cursor:pointer;touch-action: manipulation;min-height:44px;
    }
    .starBtn:hover{background: rgba(26,115,232,.08)}
    .starBtn svg{width: 30px; height: 30px}
    .hint{color: var(--muted); font-size: 12px}
    textarea{
      width:100%;min-height: 92px;resize: vertical;
      border-radius: 16px;border: 1px solid var(--line);
      padding: 10px 12px;outline:none;font-size: 14px;background:#fff;
    }
    textarea:focus{
      border-color: rgba(26,115,232,.35);
      box-shadow: 0 0 0 4px rgba(26,115,232,.12);
    }
    .danger{color: var(--danger); font-weight:1000}

    .reviewsList{
      display:grid;gap: 10px;margin-top: 10px;
    }
    .reviewItem{
      background:#fff;border: 1px solid var(--line);
      border-radius: 16px;padding: 10px 12px;
      display:flex;gap: 10px;align-items:flex-start;
    }
    .rAvatar{
      width: 36px; height: 36px;border-radius: 999px;
      border: 1px solid var(--line);
      object-fit: cover;background:#fff;flex:0 0 auto;
    }
    .rMain{min-width:0; flex:1}
    .rTop{
      display:flex;align-items:center;justify-content:space-between;
      gap: 8px;flex-wrap:wrap;
    }
    .rName{
      font-weight:1000;font-size: 13px;
      max-width: 260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .rTime{color: var(--muted);font-size: 12px;white-space:nowrap;}
    .rComment{
      margin-top: 6px;font-size: 13px;line-height: 1.45;
      color: var(--text);white-space: pre-wrap;word-break: break-word;
    }
    .voteRow{
      margin-top: 8px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .voteBtn{
      height: 36px;
      border-radius: 999px;
      padding: 0 10px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      display:inline-flex;
      align-items:center;
      gap: 6px;
      cursor:pointer;
      font-weight:1000;
      min-height:44px;
    }
    .voteBtn.active{
      border-color: rgba(26,115,232,.45);
      box-shadow: 0 0 0 4px rgba(26,115,232,.10);
      color: var(--brand2);
    }
    .voteBtn svg{width:16px;height:16px}
    .voteBtn:active{transform:scale(.99)}
    .filterPill{
      font-size:12px;font-weight:1000;
      color: var(--brand2);
      background: rgba(26,115,232,.10);
      border: 1px solid rgba(26,115,232,.18);
      padding: 6px 10px;
      border-radius: 999px;
      display:none;
    }
    .filterPill.show{display:inline-flex}

    /* ===== Profile modern (no reviews list) ===== */
    .profileShell{display:grid;gap:14px;}
    .profileHero{
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(229,231,235,.85);
      box-shadow: var(--shadow2);
      background:#fff;
    }
    .profileCover{
      height: 120px;
      background: radial-gradient(1200px 240px at 20% 0%, rgba(26,115,232,.45), rgba(11,87,208,.12) 55%, rgba(15,23,42,.02) 100%),
                  linear-gradient(135deg, rgba(26,115,232,.20), rgba(16,185,129,.08));
      position:relative;
    }
    .profileBody{
      padding: 14px;
      padding-top: 0;
      position:relative;
    }
    .profileAvatar{
      width: 92px;height:92px;border-radius: 999px;
      border: 4px solid #fff;
      background:#fff;
      box-shadow: 0 14px 30px rgba(2,6,23,.18);
      object-fit:cover;
      position:absolute;
      top:-46px;left: 14px;
    }
    .profileHeaderRow{
      padding-left: 110px;
      padding-top: 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .pName{margin:0;font-size:18px;font-weight:1000;letter-spacing:.1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .pEmail{margin-top:4px;color:var(--muted);font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .profileActions{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
      padding-top: 4px;
    }
    .ghostBtn{
      height: 40px;border-radius: 999px;
      padding: 0 14px;border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      font-weight: 1000;
      cursor:pointer;
      min-height:44px;
    }
    .ghostBtn:active{transform:scale(.99)}

    .profileStats{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(0,1fr));
      gap: 10px;
    }
    .stat{
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(255,255,255,.9);
    }
    .stat .k{color:var(--muted);font-size:12px;}
    .stat .v{margin-top:4px;font-weight:1000;font-size:16px;}

    .cardList{
      border: 1px solid rgba(229,231,235,.85);
      border-radius: 22px;
      background:#fff;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardListHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(229,231,235,.8);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .cardListHead h3{margin:0;font-size:14px;font-weight:1000;color:var(--text);}
    .cardListBody{padding: 12px 14px;}
    .settingRow{
      display:flex;align-items:center;justify-content:flex-start;gap:12px;
      padding: 12px 6px;
      border-radius: 16px;
      cursor:pointer;
    }
    .settingRow:hover{background: rgba(2,6,23,.03)}
    .settingLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .settingIcon{
      width:40px;height:40px;border-radius: 14px;
      border: 1px solid rgba(229,231,235,.9);
      display:grid;place-items:center;
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 20px rgba(2,6,23,.06);
      flex:0 0 auto;
    }
    .settingText{min-width:0;}
    .settingTitle{font-weight:1000;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .settingDesc{margin-top:2px;color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .chev{display:none}

    
    /* ===== Performance: low-end friendly ===== */
    .section{content-visibility:auto; contain: content; contain-intrinsic-size: 420px;}
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important; scroll-behavior:auto !important;}
    }
/* Desktop tweaks */
    @media (min-width: 860px){
      .kv{grid-template-columns: repeat(4, minmax(0,1fr));}
      .reviewGrid{grid-template-columns: 1fr 1fr;}
      .banner{width: 560px;}
    }

    /* Mobile tweaks */
    @media (max-width: 560px){
      .overlay{display:none}
      .overlay.show{display:flex;align-items:flex-end; opacity:1; pointer-events:auto;}
      .modal{margin:0;width:100%;border-radius: 22px 22px 0 0;}
      .modalBody{max-height: calc(100dvh - 90px);}
      .tile{min-width: 200px; max-width: 200px;}
      .hero{flex-direction: column;}
      .hero .ico{width: 74px; height: 74px; border-radius: 18px;}

      /* profile centered on mobile */
      .profileAvatar{
        left: 50%;
        transform: translateX(-50%);
      }
      .profileHeaderRow{
        padding-left: 0;
        padding-top: 56px;
        text-align:center;
        flex-direction:column;
        align-items:center;
        justify-content:center;
      }
      .profileActions{justify-content:center;}
      .profileStats{grid-template-columns: repeat(2, minmax(0,1fr));}

      :root{ --navH: 64px; }

      /* prevent right overflow on very narrow screens */
      .sectionHead{flex-wrap: wrap; gap: 10px;}
      .bannerInner{flex-wrap: wrap; gap: 10px;}
      .bannerCta{width: 100%; justify-content:center;}

      /* Row card: move action button to next line so it never goes out of screen */
      .rowCard{
        grid-template-columns: 52px minmax(0,1fr);
        align-items: start;
      }
      .rowCard > .ico{width:52px;height:52px;border-radius:14px;}
      .rowMain{padding-top:2px;}
      .rowCard .btnInstall{
        grid-column: 1 / -1;
        width: 100%;
        justify-content: center;
        margin-top: 8px;
      }

    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-inner">
      <div class="topRow">
        <div class="brand" title="APK Store">
          <div class="mark" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M7 7h10v10H7z" stroke="white" stroke-width="2" opacity=".95"/>
              <path d="M9 4h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 14v-6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M9 11h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="title">APK Store</div>
        </div>

        <div class="auth">
          <button class="btnAuth primary" id="loginBtn">Login Google</button>
          <button class="avatarBtn" id="avatarBtn" aria-label="Buka profil">
            <img id="headerAvatar" alt="profil">
          </button>
        </div>
      </div>

      <div class="headerExtras" id="headerExtras">
        <div class="searchBar" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.3-4.3" stroke="#0f172a" stroke-width="2" stroke-linecap="round" opacity=".85"/>
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#0f172a" stroke-width="2" opacity=".85"/>
          </svg>
          <input id="q" type="text" placeholder="Cari aplikasi atau game..." inputmode="search" enterkeyhint="search" autocapitalize="off" autocomplete="off" />
          <div id="countPill" class="pill">0</div>
        </div>

        <div class="tabs" id="mainTabs" aria-label="Tabs">
          <div class="tab active" data-tab="apps">Aplikasi</div>
          <div class="tab" data-tab="games">Game</div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap content">
    <div id="content">
      <div class="state">Loading data...</div>
    </div>
  </main>

  <nav class="bottomNav" aria-label="Navigasi">
    <div class="bottomNav-inner">
      <button class="navBtn active" data-page="home" id="navHome">
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
        Home
      </button>
      <button class="navBtn" data-page="top" id="navTop">
        <svg viewBox="0 0 24 24" fill="none"><path d="M6 21V10m6 11V3m6 18v-8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Top
      </button>
      <button class="navBtn" data-page="profile" id="navProfile">
        <svg viewBox="0 0 24 24" fill="none"><path d="M20 21a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2"/></svg>
        Profil
      </button>
    </div>
  </nav>

  <!-- Detail modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">Detail</div>
        <button class="xbtn" id="closeBtn" aria-label="Tutup">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6 6 18" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <!-- Dialog / info modal (for profile info + confirmations) -->
  <div class="overlay dialog" id="dialogOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle">
      <div class="modalTop">
        <div class="modalTitle" id="dialogTitle">Dialog</div>
        <button class="xbtn" id="dialogCloseBtn" aria-label="Tutup dialog">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6 6 18" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modalBody" id="dialogBody"></div>
    </div>
  </div>

  <div id="toast" style="
    position:fixed;left:50%;bottom:calc(var(--navH) + 18px + var(--safeB));transform:translateX(-50%);
    background:rgba(2,6,23,.92);color:#fff;padding:10px 12px;border-radius:999px;
    font-size:13px;display:none;z-index:400;box-shadow:0 18px 40px rgba(2,6,23,.35);
    max-width:92vw;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      set,
      remove
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ====== Firebase config ======
    // ✅ Firebase config kamu
    const firebaseConfig = {
      apiKey: "AIzaSyAu--L2T5_o9xLVT09mXFLIcpPuLLWlL1Q",
      authDomain: "aplikasi-percobaan-dbf84.firebaseapp.com",
      databaseURL: "https://aplikasi-percobaan-dbf84-default-rtdb.firebaseio.com",
      projectId: "aplikasi-percobaan-dbf84",
      storageBucket: "aplikasi-percobaan-dbf84.appspot.com",
      messagingSenderId: "52109851315",
      appId: "1:52109851315:web:ba255b74b4ce0500774ec6",
      measurementId: "G-H6WCVTQQEM"
    };

    // ====== Helpers ======
    const $ = (id)=>document.getElementById(id);
    const contentEl = $("content");
    const qEl = $("q");
    const countPill = $("countPill");
    const headerExtras = $("headerExtras");
    const overlay = $("overlay");
    const modalBody = $("modalBody");
    const modalTitle = $("modalTitle");
    const closeBtn = $("closeBtn");
    const dialogOverlay = $("dialogOverlay");
    const dialogBody = $("dialogBody");
    const dialogTitle = $("dialogTitle");
    const dialogCloseBtn = $("dialogCloseBtn");
    const toastEl = $("toast");
    const loginBtn = $("loginBtn");
    const avatarBtn = $("avatarBtn");
    const headerAvatar = $("headerAvatar");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.style.display="none", 1900);
    }

    function openDialog(title, html){
      // Pastikan tidak ketutup overlay preview/detail
      if (overlay.classList.contains("show")) closeDetail();
      dialogTitle.textContent = title;
      dialogBody.innerHTML = html;
      dialogOverlay.classList.add("show");
      dialogOverlay.setAttribute("aria-hidden","false");
      lockBodyScroll(true);
    }
    function closeDialog(){
      dialogOverlay.classList.remove("show");
      dialogOverlay.setAttribute("aria-hidden","true");
      if (!overlay.classList.contains("show")) lockBodyScroll(false);
    }

    function confirmLogout(){
      openDialog("Logout", `
        <div class="panel">
          <div class="panelHead"><h3>Logout</h3></div>
          <p style="margin:0">Yakin ingin logout dari akun ini?</p>
          <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px">
            <button class="btn" id="dlgCancel" type="button">Batal</button>
            <button class="btn dangerSolid" id="dlgLogout" type="button">Logout</button>
          </div>
        </div>
      `);

      const cancelBtn = document.getElementById("dlgCancel");
      const okBtn = document.getElementById("dlgLogout");
      if (cancelBtn) cancelBtn.onclick = closeDialog;
      if (okBtn) okBtn.onclick = async ()=>{
        okBtn.disabled = true;
        okBtn.style.opacity = ".85";
        try{
          await signOut(auth);
          closeDialog();
          toast("Logout berhasil.");
        } catch(e){
          console.error(e);
          toast("Logout gagal.");
          okBtn.disabled = false;
          okBtn.style.opacity = "1";
        }
      };
    }
    function safeText(v, fallback=""){ return (typeof v === "string" || typeof v === "number") ? String(v) : fallback; }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function parseDate(v){
      if (!v) return null;
      if (typeof v === "number") return new Date(v);
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }
    function fmtDate(v){
      const d = parseDate(v);
      if (!d) return "-";
      const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }
    function timeAgo(ts){
      const d = new Date(Number(ts)||0);
      if (!ts || isNaN(d.getTime())) return "";
      const diff = Math.max(0, Date.now() - d.getTime());
      const m = Math.floor(diff/60000);
      if (m < 1) return "baru saja";
      if (m < 60) return `${m} menit lalu`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h} jam lalu`;
      const day = Math.floor(h/24);
      if (day < 30) return `${day} hari lalu`;
      return fmtDate(d.getTime());
    }
    function fmtNum(n){
      const x = Number(n);
      if (!isFinite(x)) return "0";
      if (x >= 1e6) return (x/1e6).toFixed(1).replace(/\.0$/,"")+"M";
      if (x >= 1e3) return (x/1e3).toFixed(1).replace(/\.0$/,"")+"K";
      return String(Math.round(x));
    }
    function isNew(updatedAt){
      const d = parseDate(updatedAt);
      if (!d) return false;
      const diff = (Date.now() - d.getTime()) / (1000*60*60*24);
      return diff <= 30;
    }

    function starsDisplay(avg){
      const rating = Math.max(0, Math.min(5, Number(avg)||0));
      let html = `<span class="stars" title="Rating ${rating.toFixed(1)}">`;
      for(let i=1;i<=5;i++){
        const on = (i <= Math.round(rating));
        html += `
          <svg viewBox="0 0 24 24" class="${on ? "on":"off"}" aria-hidden="true">
            <path d="M12 17.3l-6.2 3.4 1.5-7L1.9 8.9l7.2-1L12 1.5l2.9 6.4 7.2 1-5.4 4.8 1.5 7z"/>
          </svg>`;
      }
      html += `</span>`;
      return html;
    }
    function starSvg(on){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path fill="${on ? "var(--star)" : "var(--starOff)"}"
            d="M12 17.3l-6.2 3.4 1.5-7L1.9 8.9l7.2-1L12 1.5l2.9 6.4 7.2 1-5.4 4.8 1.5 7z"/>
        </svg>
      `;
    }
    function iconPencil(){
      return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`;
    }
    function iconShare(){
      return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M15 8a3 3 0 1 0-2.8-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M7 12l10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M7 12l10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/><path d="M18 21a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/></svg>`;
    }
    function iconDownload(){
      return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
    }
    function iconBookmark(){
      return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 3h12a1 1 0 0 1 1 1v17l-7-4-7 4V4a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`;
    }
    function iconThumbUp(){
      return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 10V4a2 2 0 0 0-2-2L7 12v10h10a2 2 0 0 0 2-1.5l2-7A2 2 0 0 0 19 10h-5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M7 12H4v10h3" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`;
    }
    function iconThumbDown(){
      return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M10 14v6a2 2 0 0 0 2 2l5-10V2H7a2 2 0 0 0-2 1.5l-2 7A2 2 0 0 0 5 14h5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M17 12h3V2h-3" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`;
    }

    function iconChevronRight(){
      return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M10 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
    }
    function iconChevronDown(){
      return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 10l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
    }

    function computeReviewStats(reviewsObj){
      if (!reviewsObj || typeof reviewsObj !== "object") return { avg: 0, count: 0, dist:[0,0,0,0,0] };
      let sum = 0, count = 0;
      const dist = [0,0,0,0,0];
      for (const uid in reviewsObj){
        const s = Number(reviewsObj[uid]?.stars);
        if (isFinite(s) && s >= 1 && s <= 5){
          sum += s; count += 1;
          dist[s-1] += 1;
        }
      }
      return { avg: count ? (sum/count) : 0, count, dist };
    }

    function computeVoteCounts(votesObj){
      const counts = {};
      if (!votesObj || typeof votesObj !== "object") return counts;
      for (const reviewUid of Object.keys(votesObj)){
        const m = votesObj[reviewUid] || {};
        let like = 0, dislike = 0;
        for (const voterUid of Object.keys(m)){
          const val = Number(m[voterUid]);
          if (val === 1) like += 1;
          else if (val === -1) dislike += 1;
        }
        counts[reviewUid] = { like, dislike, score: like - dislike };
      }
      return counts;
    }

    // ====== Firebase init ======
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ====== Keyboard fix: hide bottom nav when keyboard open ======
    function updateKeyboardState(){
      const vv = window.visualViewport;
      if (!vv) return;
      const ratio = vv.height / window.innerHeight;
      const open = ratio < 0.78; // threshold
      document.body.classList.toggle("kbd", open);
    }
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", updateKeyboardState);
      window.visualViewport.addEventListener("scroll", updateKeyboardState);
    }
    document.addEventListener("focusin",(e)=>{
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")){
        setTimeout(updateKeyboardState, 0);
      }
    });
    document.addEventListener("focusout",(e)=>{
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")){
        setTimeout(updateKeyboardState, 50);
      }
    });

    // ====== State ======
    let currentUser = null;
    let allApps = [];
    let currentAppId = null;

    // modal listeners
    let unsubscribeReviews = null;
    let unsubscribeVotes = null;

    // user whitelist listener
    let unsubscribeWhitelist = null;
    let whitelist = {}; // {appId: true|{addedAt}}

    // detail state
    let reviewFilterStar = 0; // 0=default (popular by likes), else 1..5
    let currentVotes = {};    // raw votes
    let voteCounts = {};      // {reviewUid:{like,dislike,score}}

    const state = {
      tab: "apps",      // apps|games
      page: "home",     // home|top|profile
      query: "",
      sort: "popular"   // popular|rating|latest (ONLY on Top page)
    };

    function updateHeaderVisibility(){
      headerExtras.classList.toggle("hidden", state.page === "profile");
    }

    function typeOfApp(a){
      const t = String(a.type || "").toLowerCase().trim();
      if (t === "game" || t === "games") return "games";
      if (t === "app" || t === "apps") return "apps";
      return "apps";
    }

    function normalizeApps(raw){
      const arr = [];
      if (!raw || typeof raw !== "object") return arr;
      for(const id of Object.keys(raw)){
        const a = raw[id] || {};
        arr.push({
          id,
          type: safeText(a.type, ""),
          name: safeText(a.name, "Untitled"),
          description: safeText(a.description, ""),
          version: safeText(a.version, ""),
          size: safeText(a.size, ""),
          updatedAt: a.updatedAt ?? null,
          category: safeText(a.category, "Lainnya"),
          developer: safeText(a.developer, ""),
          minAndroid: safeText(a.minAndroid, ""),
          downloads: Number(a.downloads || 0),
          mod: Boolean(a.mod || false),
          icon: safeText(a.icon, "icon/default.png"),
          downloadUrl: safeText(a.downloadUrl, ""),
          changelog: safeText(a.changelog, ""),
          screenshots: Array.isArray(a.screenshots) ? a.screenshots.slice(0, 12) : [],
          reviews: (a.reviews && typeof a.reviews === "object") ? a.reviews : null
        });
      }
      return arr;
    }

    // ====== Auth ======
    function stopWhitelistListener(){
      if (typeof unsubscribeWhitelist === "function"){
        try{ unsubscribeWhitelist(); }catch{}
      }
      unsubscribeWhitelist = null;
      whitelist = {};
    }
    function startWhitelistListener(uid){
      stopWhitelistListener();
      const wRef = ref(db, `users/${uid}/whitelist`);
      unsubscribeWhitelist = onValue(wRef, (snap)=>{
        whitelist = snap.exists() ? (snap.val() || {}) : {};
        // update button state if modal open
        if (currentAppId) updateWhitelistButton(currentAppId);
        if (state.page === "profile") render();
      });
    }

    onAuthStateChanged(auth, (user)=>{
      currentUser = user || null;
      if (currentUser){
        loginBtn.style.display = "none";
        avatarBtn.style.display = "grid";
        headerAvatar.src = currentUser.photoURL || "icon/default.png";
        startWhitelistListener(currentUser.uid);
      } else {
        loginBtn.style.display = "inline-flex";
        avatarBtn.style.display = "none";
        stopWhitelistListener();
      }

      if (currentAppId) refreshReviewForm(currentAppId);
      if (state.page === "profile") render();
    });

    loginBtn.onclick = async ()=>{
      try{
        await signInWithPopup(auth, provider);
        toast("Login berhasil!");
      } catch (e){
        toast("Login gagal. Cek Authorized domains.");
        console.error(e);
      }
    };

    avatarBtn.onclick = ()=>{
      state.page = "profile";
      setActiveNav();
      updateHeaderVisibility();
      render();
      window.scrollTo({top:0, behavior:"smooth"});
    };

    // ====== Tabs + Nav ======
    document.getElementById("mainTabs").addEventListener("click",(e)=>{
      const tab = e.target?.dataset?.tab;
      if (!tab) return;
      state.tab = tab;
      // keep current page (home/top/profile) when switching tab
      // so switching Apps/Game does not force back to Home.
      setActiveTabs();
      setActiveNav();
      updateHeaderVisibility();
      render();
      window.scrollTo({top:0, behavior:"smooth"});
    });

    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.page = btn.dataset.page;
        setActiveNav();
        updateHeaderVisibility();
        render();
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });

    function setActiveTabs(){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab === state.tab);
      });
    }
    function setActiveNav(){
      document.querySelectorAll(".navBtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.page === state.page);
      });
    }

    // ====== Search ======
    let tmr = null;
    qEl.addEventListener("input", ()=>{
      clearTimeout(tmr);
      tmr = setTimeout(()=>{
        state.query = qEl.value || "";
        state.page = "home";
        setActiveNav();
        updateHeaderVisibility();
        render();
      }, 120);
    });

    function matchesQuery(a){
      const q = state.query.trim().toLowerCase();
      if (!q) return true;
      const hay = `${a.name} ${a.description} ${a.category} ${a.developer} ${a.version}`.toLowerCase();
      return hay.includes(q);
    }
    function filteredByTab(){
      return allApps.filter(a => typeOfApp(a) === state.tab);
    }
    function filteredApps(){
      return filteredByTab().filter(a => matchesQuery(a));
    }

    function sortItems(items, sortKey){
      const copy = items.slice();
      if (sortKey === "latest"){
        return copy.sort((x,y)=>{
          const dx = parseDate(x.updatedAt)?.getTime() || 0;
          const dy = parseDate(y.updatedAt)?.getTime() || 0;
          return dy - dx;
        });
      }
      if (sortKey === "rating"){
        return copy.sort((x,y)=>{
          const rx = computeReviewStats(x.reviews).avg;
          const ry = computeReviewStats(y.reviews).avg;
          if (ry !== rx) return ry - rx;
          return (Number(y.downloads||0)-Number(x.downloads||0));
        });
      }
      // popular
      return copy.sort((x,y)=>(Number(y.downloads||0)-Number(x.downloads||0)));
    }

    // ====== Categories list (no chips) ======
    function categoriesForTab(){
      const cats = new Map();
      for (const a of filteredByTab()){
        const c = a.category || "Lainnya";
        cats.set(c, (cats.get(c)||0)+1);
      }
      return Array.from(cats.entries()).sort((x,y)=>y[1]-x[1]).map(([c])=>c);
    }

    // ====== UI components ======
    function createTile(a){
      const {avg} = computeReviewStats(a.reviews);
      const div = document.createElement("div");
      div.className = "tile";
      div.onclick = ()=>openDetail(a.id);
      div.innerHTML = `
        <img class="ico" src="${a.icon || "icon/default.png"}" alt="${escapeHtml(a.name)}" onerror="this.src='icon/default.png'">
        <div class="tileMain">
          <p class="tileName">${escapeHtml(a.name)}</p>
          <div class="tileMeta">
            <span>${starsDisplay(avg)}</span>
            <span class="ratingNum">${avg ? avg.toFixed(1) : "0.0"}</span>
          </div>
        </div>
      `;
      return div;
    }

    function createRowCard(a, idx=null, minimalMeta=false){
      const {avg, count} = computeReviewStats(a.reviews);
      const card = document.createElement("div");
      card.className = "rowCard";
      card.onclick = ()=>openDetail(a.id);

      const badges = [];
      if (isNew(a.updatedAt)) badges.push(`<span class="badge new">NEW</span>`);
      if (a.mod) badges.push(`<span class="badge mod">MOD</span>`);
      const rank = (idx !== null) ? `<span class="badge" style="margin-right:6px">#${idx+1}</span>` : ``;

      card.innerHTML = `
        <img class="ico" src="${a.icon || "icon/default.png"}" alt="${escapeHtml(a.name)}" onerror="this.src='icon/default.png'">
        <div class="rowMain">
          <div class="rowTitle">
            <h3 class="rowName">${rank}${escapeHtml(a.name)}</h3>
            <div style="display:flex;gap:6px;align-items:center">${badges.join("")}</div>
          </div>
          <div class="rowDesc">${escapeHtml(a.description || "-")}</div>
          ${minimalMeta ? "" : `
            <div class="rowMeta">
              <span>${starsDisplay(avg)}</span>
              <span class="ratingNum">${avg ? avg.toFixed(1) : "0.0"}</span>
              <span>(${count})</span>
              <span>•</span>
              <span>${fmtNum(a.downloads)} download</span>
              <span>•</span>
              <span>Update ${fmtDate(a.updatedAt)}</span>
            </div>
          `}
        </div>
        <button class="btnInstall" type="button">${iconDownload()} Install</button>
      `;

      const btn = card.querySelector(".btnInstall");
      btn.onclick = (e)=>{
        e.stopPropagation();
        if (!a.downloadUrl){
          toast("Link download belum diisi.");
          return;
        }
        window.open(a.downloadUrl, "_blank", "noopener");
      };

      return card;
    }

    function sectionBlock(title, items, onSeeAll){
      const section = document.createElement("section");
      section.className = "section";
      const head = document.createElement("div");
      head.className = "sectionHead";
      head.innerHTML = `
        ${onSeeAll
          ? `<button class="sectionLink" type="button" aria-label="Buka ${escapeHtml(title)}">
              <span class="sectionTitle">${escapeHtml(title)}</span>
              <span class="chevMini">${iconChevronRight()}</span>
            </button>`
          : `<div class="sectionTitle">${escapeHtml(title)}</div>`
        }
      `;
      if (onSeeAll) head.querySelector("button").onclick = onSeeAll;

      const row = document.createElement("div");
      row.className = "hscroll";
      for(const a of items){ row.appendChild(createTile(a)); }

      section.appendChild(head);
      section.appendChild(row);
      return section;
    }

    function bannerCard(a){
      const {avg, count} = computeReviewStats(a.reviews);
      const div = document.createElement("div");
      div.className = "banner";
      div.onclick = ()=>openDetail(a.id);

      const bg = (a.screenshots && a.screenshots.length) ? a.screenshots[0] : (a.icon || "icon/default.png");

      div.innerHTML = `
        <div class="bannerBg"></div>
        <img class="bannerImg" src="${bg}" alt="" onerror="this.style.display='none'">
        <div class="bannerInner">
          <img class="bannerIco" src="${a.icon || "icon/default.png"}" alt="${escapeHtml(a.name)}" onerror="this.src='icon/default.png'">
          <div class="bannerMain">
            <h3 class="bannerTitle">${escapeHtml(a.name)}</h3>
            <div class="bannerDesc">${escapeHtml(a.description || "")}</div>
            <div class="bannerMeta">
              <span>${starsDisplay(avg)}</span>
              <span class="ratingNum">${avg ? avg.toFixed(1) : "0.0"}</span>
              <span>(${count})</span>
              <span>•</span>
              <span>${fmtNum(a.downloads)} download</span>
            </div>
          </div>
          <button class="bannerCta" type="button">Lihat</button>
        </div>
      `;

      div.querySelector(".bannerCta").onclick = (e)=>{
        e.stopPropagation();
        openDetail(a.id);
      };
      return div;
    }

    // ====== Pages ======
    function renderHome(){
      const apps = filteredApps();
      countPill.textContent = `${apps.length}`;
      contentEl.innerHTML = "";

      if (apps.length === 0){
        contentEl.innerHTML = `<div class="state">Belum ada data di tab ini. Tambahkan data di RTDB: <b>apps/{appId}</b></div>`;
        return;
      }

      // Search results (list)
      if (state.query.trim()){
        const head = document.createElement("div");
        head.className = "sectionHead";
        head.innerHTML = `<div class="sectionTitle">Hasil pencarian</div><div class="pill">${apps.length} hasil</div>`;
        contentEl.appendChild(head);

        const vlist = document.createElement("div");
        vlist.className = "vlist";
        sortItems(apps, "popular").slice(0, 120).forEach((a)=>vlist.appendChild(createRowCard(a, null)));
        contentEl.appendChild(vlist);
        return;
      }

      // Banner populer
      const topPopular = sortItems(apps, "popular").slice(0, 6);
      const bannerSec = document.createElement("section");
      bannerSec.className = "section";
      bannerSec.innerHTML = `
        <div class="sectionHead">
          <div class="sectionTitle">${state.tab === "games" ? "Populer Game" : "Populer Aplikasi"}</div>
          <button class="arrowBtn" type="button" id="goTopBtn" aria-label="Buka Top">${iconChevronRight()}</button>
        </div>
      `;
      const row = document.createElement("div");
      row.className = "bannerRow";
      topPopular.forEach(a => row.appendChild(bannerCard(a)));
      bannerSec.appendChild(row);
      contentEl.appendChild(bannerSec);
      bannerSec.querySelector("#goTopBtn").onclick = ()=>{
        state.page = "top";
        setActiveNav();
        updateHeaderVisibility();
        render();
      };

      // kategori sections
      const cats = categoriesForTab().slice(0, 12);
      for (const c of cats){
        const items = sortItems(apps.filter(a => (a.category || "Lainnya") === c), "popular");
        if (!items.length) continue;
        contentEl.appendChild(sectionBlock(c, items.slice(0, 12), ()=>{
          state.page = "top";
          setActiveNav();
          updateHeaderVisibility();
          render();
        }));
      }
    }

    function renderTop(){
      const apps = filteredApps();
      countPill.textContent = `${apps.length}`;
      contentEl.innerHTML = "";

      const head = document.createElement("div");
      head.className = "sectionHead";
      head.innerHTML = `
        <div class="sectionTitle">Top ${state.tab === "games" ? "Game" : "Aplikasi"}</div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="pill">Urutkan</div>
          <select id="sortOnly" class="selectPill" aria-label="Urutkan daftar">
            <option value="popular">Populer</option>
            <option value="rating">Rating</option>
            <option value="latest">Terbaru</option>
          </select>
        </div>
      `;
      contentEl.appendChild(head);

      const sortOnly = head.querySelector("#sortOnly");
      sortOnly.value = state.sort;
      sortOnly.onchange = ()=>{
        state.sort = sortOnly.value;
        render();
      };

      const vlist = document.createElement("div");
      vlist.className = "vlist";
      const sorted = sortItems(apps, state.sort);
      if (sorted.length === 0){
        vlist.innerHTML = `<div class="state">Tidak ada data.</div>`;
      } else {
        sorted.slice(0, 200).forEach((a,i)=>vlist.appendChild(createRowCard(a, i)));
      }
      contentEl.appendChild(vlist);
    }

    function appById(id){ return allApps.find(x=>x.id===id); }

    async function renderProfile(){
      contentEl.innerHTML = "";
      countPill.textContent = "";

      const shell = document.createElement("div");
      shell.className = "profileShell";

      // Guest
      if (!currentUser){
        shell.innerHTML = `
          <div class="profileHero">
            <div class="profileCover"></div>
            <div class="profileBody">
              <img class="profileAvatar" src="icon/default.png" alt="avatar" onerror="this.src='icon/default.png'">
              <div class="profileHeaderRow">
                <div style="min-width:0">
                  <p class="pName">Guest</p>
                  <div class="pEmail">Login untuk whitelist & ulasan</div>
                </div>
                <div class="profileActions">
                  <button class="ghostBtn" id="pLogin">Login Google</button>
                </div>
              </div>

              <div class="profileStats">
                <div class="stat"><div class="k">Whitelist</div><div class="v">0</div></div>
                <div class="stat"><div class="k">Tab</div><div class="v">${state.tab === "games" ? "Game" : "Aplikasi"}</div></div>
                
              </div>
            </div>
          </div>

          <div class="cardList">
            <div class="cardListHead"><h3>Akun</h3><span class="pill">Masuk untuk fitur lengkap</span></div>
            <div class="cardListBody">
              <div class="settingRow" id="rLogin">
                <div class="settingLeft">
                  <div class="settingIcon">🔐</div>
                  <div class="settingText">
                    <div class="settingTitle">Login <span class="chevMini">›</span></div>
                    <div class="settingDesc">Whitelist & 1 akun = 1 ulasan</div>
                  </div>
                </div>
                
              </div>
            </div>
          </div>
        `;
        contentEl.appendChild(shell);

        shell.querySelector("#pLogin").onclick = ()=>loginBtn.click();
        shell.querySelector("#rLogin").onclick = ()=>loginBtn.click();
        return;
      }

      const wIds = Object.keys(whitelist || {});
      const wItems = wIds.map(id => appById(id)).filter(Boolean);

      shell.innerHTML = `
        <div class="profileHero">
          <div class="profileCover"></div>
          <div class="profileBody">
            <img class="profileAvatar" src="${currentUser.photoURL || "icon/default.png"}" alt="avatar" onerror="this.src='icon/default.png'">
            <div class="profileHeaderRow">
              <div style="min-width:0">
                <p class="pName">${escapeHtml(currentUser.displayName || "User")}</p>
                <div class="pEmail">${escapeHtml(currentUser.email || "-")}</div>
              </div>
            </div>

            <div class="profileStats">
              <div class="stat"><div class="k">Whitelist</div><div class="v">${wItems.length}</div></div>
              <div class="stat"><div class="k">UID</div><div class="v" title="${escapeHtml(currentUser.uid)}">${escapeHtml(currentUser.uid).slice(0,8)}…</div></div>
              <div class="stat"><div class="k">Tab</div><div class="v">${state.tab === "games" ? "Game" : "Aplikasi"}</div></div>
            </div>
          </div>
        </div>

        <div class="cardList" id="wlCard">
          <div class="cardListHead">
            <h3>Whitelist</h3>
            <span class="pill">${wItems.length ? "Tap untuk buka" : "Kosong"}</span>
          </div>
          <div class="cardListBody" id="wlBody"></div>
        </div>

        <div class="cardList">
          <div class="cardListHead"><h3>Tentang</h3><span class="pill">v1</span></div>
          <div class="cardListBody">
            <div class="settingRow" id="howData">
              <div class="settingLeft">
                <div class="settingIcon">🧩</div>
                <div class="settingText">
                  <div class="settingTitle">Struktur data <span class="chevMini">›</span></div>
                  <div class="settingDesc">apps/{appId} + reviews/{uid} + whitelist</div>
                </div>
              </div>
              
            </div>

            <div class="settingRow" id="rulesTip">
              <div class="settingLeft">
                <div class="settingIcon">🛡️</div>
                <div class="settingText">
                  <div class="settingTitle">Keamanan <span class="chevMini">›</span></div>
                  <div class="settingDesc">Rules: auth.uid == $uid (review & whitelist)</div>
                </div>
              </div>
              
            </div>

            <div class="settingRow" id="logoutRow">
              <div class="settingLeft">
                <div class="settingIcon">🚪</div>
                <div class="settingText">
                  <div class="settingTitle">Logout <span class="chevMini">›</span></div>
                  <div class="settingDesc">Keluar dari akun Google</div>
                </div>
              </div>
              
            </div>
          </div>
        </div>
      `;
      contentEl.appendChild(shell);

      shell.querySelector("#howData").onclick = ()=>{
        openDialog("Struktur data", `
          <div class="panel">
            <div class="panelHead"><h3>Struktur data</h3></div>
            <p>
              Data tersimpan di Firebase Realtime Database (RTDB).

              • apps/{appId} → metadata aplikasi/game

              • apps/{appId}/reviews/{uid} → 1 akun = 1 ulasan

              • users/{uid}/whitelist/{appId} → item yang kamu simpan
            </p>
          </div>
        `);
      };

      shell.querySelector("#rulesTip").onclick = ()=>{
        openDialog("Keamanan", `
          <div class="panel">
            <div class="panelHead"><h3>Keamanan</h3></div>
            <p>
              Saran rules dasar:

              • Write review hanya untuk auth.uid milik user

              • Whitelist hanya boleh write/read oleh user terkait

              • Votes ulasan juga dibatasi auth.uid

              (Supaya tidak ada user lain yang mengubah data akunmu.)
            </p>
          </div>
        `);
      };

      shell.querySelector("#logoutRow").onclick = ()=>confirmLogout();

      const wlBody = shell.querySelector("#wlBody");
      if (!wItems.length){
        wlBody.innerHTML = `<div class="state" style="margin:0">Belum ada whitelist. Buka detail item → tambahkan ke whitelist.</div>`;
      } else {
        const list = document.createElement("div");
        list.className = "vlist";
        wItems.slice(0, 120).forEach((a)=>{
          const card = createRowCard(a, null, true);
          // replace install button -> remove from whitelist
          const btn = card.querySelector(".btnInstall");
          btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Hapus`;
          btn.style.background = "rgba(239,68,68,.10)";
          btn.style.borderColor = "rgba(239,68,68,.22)";
          btn.style.color = "#b91c1c";
          btn.onclick = async (e)=>{
            e.stopPropagation();
            await removeWhitelist(a.id);
          };
          list.appendChild(card);
        });
        wlBody.appendChild(list);
      }
    }

    function render(){
      if (state.page === "top") return renderTop();
      if (state.page === "profile") return renderProfile();
      return renderHome();
    }

    // ====== Whitelist ======
    function isWhitelisted(appId){
      return Boolean(whitelist && whitelist[appId]);
    }
    async function addWhitelist(appId){
      if (!currentUser){
        toast("Login dulu untuk whitelist.");
        return false;
      }
      await set(ref(db, `users/${currentUser.uid}/whitelist/${appId}`), { addedAt: Date.now() });
      toast("Ditambahkan ke whitelist.");
      return true;
    }
    async function removeWhitelist(appId){
      if (!currentUser){
        toast("Login dulu.");
        return false;
      }
      await remove(ref(db, `users/${currentUser.uid}/whitelist/${appId}`));
      toast("Dihapus dari whitelist.");
      return true;
    }
    async function toggleWhitelist(appId){
      if (isWhitelisted(appId)) return removeWhitelist(appId);
      return addWhitelist(appId);
    }
    function updateWhitelistButton(appId){
      const btn = document.getElementById("whitelistBtn");
      if (!btn) return;
      const on = isWhitelisted(appId);
      btn.classList.toggle("on", on);
      btn.innerHTML = `${iconBookmark()} ${on ? "Whitelisted" : "Whitelist"}`;
    }

    // ====== Votes for reviews ======
    function myVote(reviewUid){
      if (!currentUser) return 0;
      return Number(currentVotes?.[reviewUid]?.[currentUser.uid] || 0);
    }
    async function setVote(appId, reviewUid, val){
      if (!currentUser){
        toast("Login dulu untuk vote.");
        return;
      }
      const path = `apps/${appId}/reviewVotes/${reviewUid}/${currentUser.uid}`;
      const v = myVote(reviewUid);
      // toggle behavior
      if (v === val){
        await remove(ref(db, path));
      } else {
        await set(ref(db, path), val);
      }
    }

    // ====== Reviews LIVE + filter ======
    function setReviewFilter(star){
      reviewFilterStar = star;
      const pill = document.getElementById("filterPill");
      if (pill){
        pill.classList.toggle("show", reviewFilterStar !== 0);
        pill.textContent = reviewFilterStar ? `Filter: ${reviewFilterStar}★` : "";
      }
      // highlight bars
      document.querySelectorAll(".barRow").forEach(r=>{
        const s = Number(r.dataset.star || 0);
        r.classList.toggle("active", reviewFilterStar !== 0 && s === reviewFilterStar);
      });
      if (currentAppId){
        const a = appById(currentAppId);
        renderReviewsList(currentAppId, a?.reviews || {});
      }
    }

    function updateReviewStatsUI(reviews){
      const stats = computeReviewStats(reviews || {});
      const avg = stats.avg ? stats.avg.toFixed(1) : "0.0";

      // Hero
      const heroStars = document.getElementById("heroStars");
      const heroAvg = document.getElementById("heroAvg");
      const heroCount = document.getElementById("heroCount");
      if (heroStars) heroStars.innerHTML = starsDisplay(stats.avg);
      if (heroAvg) heroAvg.textContent = avg;
      if (heroCount) heroCount.textContent = `(${stats.count} ulasan)`;

      // Panel header
      const avgStarsEl = document.getElementById("avgStars");
      const avgNum = document.getElementById("avgNum");
      const reviewCount = document.getElementById("reviewCount");
      if (avgStarsEl) avgStarsEl.innerHTML = starsDisplay(stats.avg);
      if (avgNum) avgNum.textContent = avg;
      if (reviewCount) reviewCount.textContent = `(${stats.count})`;

      // Big
      const bigAvg = document.getElementById("bigAvg");
      const bigStars = document.getElementById("bigStars");
      const bigCount = document.getElementById("bigCount");
      if (bigAvg) bigAvg.textContent = avg;
      if (bigStars) bigStars.innerHTML = starsDisplay(stats.avg);
      if (bigCount) bigCount.textContent = `${stats.count} ulasan`;

      // Bars
      const total = Math.max(1, stats.count);
      [5,4,3,2,1].forEach((s)=>{
        const span = document.querySelector(`.bar > span[data-star="${s}"]`);
        const pctEl = document.querySelector(`.barPct[data-star="${s}"]`);
        if (!span) return;
        const c = stats.dist[s-1] || 0;
        const pct = Math.round((c/total)*100);
        span.style.width = pct + "%";
        if (pctEl) pctEl.textContent = pct + "%";
      });
    }

    function stopDetailListeners(){
      if (typeof unsubscribeReviews === "function"){
        try{ unsubscribeReviews(); }catch{}
      }
      if (typeof unsubscribeVotes === "function"){
        try{ unsubscribeVotes(); }catch{}
      }
      unsubscribeReviews = null;
      unsubscribeVotes = null;
      currentVotes = {};
      voteCounts = {};
    }

    function attachReviewsListener(appId){
      stopDetailListeners();

      const rRef = ref(db, `apps/${appId}/reviews`);
      unsubscribeReviews = onValue(rRef, (snap)=>{
        const reviews = snap.exists() ? snap.val() : {};
        const idx = allApps.findIndex(x=>x.id===appId);
        if (idx !== -1) allApps[idx].reviews = reviews;

        updateReviewStatsUI(reviews);
        renderReviewsList(appId, reviews);
        refreshMyReviewSummary(appId, reviews);
      });

      const vRef = ref(db, `apps/${appId}/reviewVotes`);
      unsubscribeVotes = onValue(vRef, (snap)=>{
        currentVotes = snap.exists() ? (snap.val() || {}) : {};
        voteCounts = computeVoteCounts(currentVotes);
        // rerender list (popular depends on likes)
        const a = appById(appId);
        renderReviewsList(appId, a?.reviews || {});
      });
    }

    async function getMyReview(appId){
      if (!currentUser) return null;
      const uid = currentUser.uid;
      const snap = await get(ref(db, `apps/${appId}/reviews/${uid}`));
      return snap.exists() ? snap.val() : null;
    }

    async function submitReview(appId, stars, comment){
      if (!currentUser) throw new Error("Not logged in");
      const uid = currentUser.uid;

      const payload = {
        stars: Number(stars),
        comment: String(comment || ""),
        userName: currentUser.displayName || "User",
        userPhoto: currentUser.photoURL || "",
        updatedAt: Date.now()
      };

      // optimistic
      const idx = allApps.findIndex(x=>x.id===appId);
      if (idx !== -1){
        if (!allApps[idx].reviews || typeof allApps[idx].reviews !== "object") allApps[idx].reviews = {};
        allApps[idx].reviews[uid] = payload;
        updateReviewStatsUI(allApps[idx].reviews);
        renderReviewsList(appId, allApps[idx].reviews);
      }

      await set(ref(db, `apps/${appId}/reviews/${uid}`), payload);
      return payload;
    }

    function lockBodyScroll(lock){
      document.body.style.overflow = lock ? "hidden" : "";
    }

    function openDetail(id){
      const a = appById(id);
      if (!a){ toast("Item tidak ditemukan."); return; }
      currentAppId = id;

      // reset filter setiap buka detail
      reviewFilterStar = 0;

      const url = new URL(location.href);
      url.searchParams.set("id", id);
      history.replaceState({}, "", url);

      const stats = computeReviewStats(a.reviews);
      modalTitle.textContent = a.name;

      const badges = [
        isNew(a.updatedAt) ? `<span class="badge new">NEW</span>` : ``,
        a.mod ? `<span class="badge mod">MOD</span>` : ``
      ].filter(Boolean).join("");

      const shotsHtml = (a.screenshots && a.screenshots.length)
        ? `<div class="panel">
            <div class="panelHead"><h3>Screenshots</h3></div>
            <div class="shots">
              ${a.screenshots.map(s => `
                <img class="shot" src="${s}" alt="screenshot" onerror="this.style.display='none'">
              `).join("")}
            </div>
          </div>`
        : "";

      const dist = stats.dist;
      const total = Math.max(1, stats.count);

      modalBody.innerHTML = `
        <div class="hero">
          <img class="ico" src="${a.icon || "icon/default.png"}" alt="${escapeHtml(a.name)}" onerror="this.src='icon/default.png'">
          <div style="min-width:0">
            <h2>${escapeHtml(a.name)}</h2>
            <div class="heroSmall">
              <span id="heroStars">${starsDisplay(stats.avg)}</span>
              <span class="ratingNum" id="heroAvg">${stats.avg ? stats.avg.toFixed(1) : "0.0"}</span>
              <span id="heroCount">(${stats.count} ulasan)</span>
              <span style="opacity:.6">•</span>
              <span>Update ${fmtDate(a.updatedAt)}</span>
              ${badges}
            </div>

            <div class="actions">
              <a class="btn primary" href="${a.downloadUrl || "#"}" target="_blank" rel="noopener" ${a.downloadUrl ? "" : "onclick='return false;'"}>
                ${iconDownload()} Install
              </a>
              <button class="btn wl" id="whitelistBtn" type="button">${iconBookmark()} Whitelist</button>
              <button class="btn ghost" id="shareBtn" type="button">${iconShare()} Share</button>
            </div>
          </div>
        </div>

        <div class="kv">
          <div class="box"><div class="k">Version</div><div class="v">${escapeHtml(a.version || "-")}</div></div>
          <div class="box"><div class="k">Size</div><div class="v">${escapeHtml(a.size || "-")}</div></div>
          <div class="box"><div class="k">Downloads</div><div class="v">${fmtNum(a.downloads)}</div></div>
          <div class="box"><div class="k">Developer</div><div class="v">${escapeHtml(a.developer || "-")}</div></div>
        </div>

        <div class="panel" id="reviewPanel">
          <div class="panelHead">
            <h3>Ratings & reviews</h3>
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
              <span class="filterPill" id="filterPill"></span>
              <div class="reviewSummary">
                <span id="avgStars">${starsDisplay(stats.avg)}</span>
                <span class="ratingNum" id="avgNum">${stats.avg ? stats.avg.toFixed(1) : "0.0"}</span>
                <span id="reviewCount">(${stats.count})</span>
              </div>
            </div>
          </div>

          <div class="reviewGrid">
            <div class="reviewStats">
              <div class="bigRating">
                <div class="num" id="bigAvg">${stats.avg ? stats.avg.toFixed(1) : "0.0"}</div>
                <div id="bigStars">${starsDisplay(stats.avg)}</div>
                <div class="hint" id="bigCount">${stats.count} ulasan</div>
              </div>

              <div class="bars" id="barsWrap">
                ${[5,4,3,2,1].map(s=>{
                  const c = dist[s-1] || 0;
                  const pct = Math.round((c/total)*100);
                  return `
                    <div class="barRow" data-star="${s}" title="Klik untuk filter ${s} bintang">
                      <div>${s}</div>
                      <div class="bar"><span data-star="${s}" style="width:${pct}%"></span></div>
                      <div class="barPct" data-star="${s}">${pct}%</div>
                    </div>
                  `;
                }).join("")}
              </div>
            </div>

            <div>
              <div class="myReviewCard" id="myReviewCard">
                <div class="myReviewTop">
                  <div class="t">Ulasan kamu</div>
                  <button class="iconBtn" id="editReviewBtn" type="button" aria-label="Edit ulasan">${iconPencil()}</button>
                </div>
                <div id="myReviewBody">
                  <div class="myReviewEmpty">Loading…</div>
                </div>
              </div>

              <div class="editor" id="reviewEditor" aria-hidden="true">
                <div class="hint" id="selectedLabel" style="margin-top:8px">Pilih rating</div>
                <div class="rateStars" id="rateStars"></div>
                <textarea id="commentBox" placeholder="Tulis ulasan kamu (opsional)..."></textarea>

                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px">
                  <div class="hint" id="reviewHint">Ketik lalu Kirim.</div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                    <button class="btn" id="cancelEditBtn" type="button">Batal</button>
                    <button class="btn primary" id="submitReviewBtn" type="button">Kirim</button>
                  </div>
                </div>

                <div class="hint" style="margin-top:8px">
                  1 akun Google = 1 ulasan. <span id="charInfo" class="hint"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="reviewsList" id="reviewsList"></div>
        </div>

        <div class="panel">
          <div class="panelHead"><h3>Deskripsi</h3></div>
          <p>${escapeHtml(a.description || "-")}</p>
        </div>

        ${a.changelog ? `
          <div class="panel">
            <div class="panelHead"><h3>Changelog</h3></div>
            <p>${escapeHtml(a.changelog)}</p>
          </div>
        ` : ""}

        ${shotsHtml}
      `;

      // actions
      document.getElementById("shareBtn").onclick = async ()=>{
        const shareUrl = location.href;
        if (navigator.share){
          try{ await navigator.share({ title: a.name, text: "Install dari APK Store", url: shareUrl }); } catch {}
        } else {
          try{ await navigator.clipboard.writeText(shareUrl); toast("Link disalin (Share tidak tersedia)."); }
          catch { toast("Browser belum support Share."); }
        }
      };

      document.getElementById("whitelistBtn").onclick = async ()=>{
        if (!currentUser){
          toast("Login dulu untuk whitelist.");
          return;
        }
        try{
          await toggleWhitelist(id);
          updateWhitelistButton(id);
        } catch (e){
          console.error(e);
          toast("Gagal whitelist. Cek Rules.");
        }
      };

      // bars clickable filter
      document.getElementById("barsWrap").addEventListener("click", (e)=>{
        const row = e.target.closest(".barRow");
        if (!row) return;
        const s = Number(row.dataset.star || 0);
        if (!s) return;
        // toggle
        if (reviewFilterStar === s) setReviewFilter(0);
        else setReviewFilter(s);
      });

      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      lockBodyScroll(true);

      // init button state + review ui
      updateWhitelistButton(id);
      setupReviewUI(id);

      // listeners
      attachReviewsListener(id);
      updateReviewStatsUI(a.reviews || {});
      renderReviewsList(id, a.reviews || {});
      refreshMyReviewSummary(id, a.reviews || {});
      setReviewFilter(0);
    }

    function closeDetail(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      lockBodyScroll(false);
      const url = new URL(location.href);
      url.searchParams.delete("id");
      history.replaceState({}, "", url);
      currentAppId = null;
      stopDetailListeners();
    }
    closeBtn.onclick = closeDetail;
    overlay.addEventListener("click",(e)=>{ if (e.target===overlay) closeDetail(); });
    dialogCloseBtn.onclick = closeDialog;
    dialogOverlay.addEventListener("click",(e)=>{ if (e.target===dialogOverlay) closeDialog(); });
    window.addEventListener("keydown",(e)=>{
      if (e.key !== "Escape") return;
      if (dialogOverlay.classList.contains("show")) return closeDialog();
      if (overlay.classList.contains("show")) return closeDetail();
    });

    // ===== Review editor + summary =====
    let _reviewFormCache = null;

    function setEditorOpen(open){
      const editor = document.getElementById("reviewEditor");
      if (!editor) return;
      editor.classList.toggle("show", open);
      editor.setAttribute("aria-hidden", open ? "false" : "true");
    }

    function refreshMyReviewSummary(appId, reviews){
      const body = document.getElementById("myReviewBody");
      const editBtn = document.getElementById("editReviewBtn");
      if (!body || !editBtn) return;

      if (!currentUser){
        body.innerHTML = `
          <div class="myReviewEmpty">Login untuk menulis ulasan.</div>
          <div class="myReviewMeta"><button class="btn" id="myLoginBtn" type="button">Login Google</button></div>
        `;
        editBtn.style.opacity = ".5";
        editBtn.disabled = true;
        const b = document.getElementById("myLoginBtn");
        if (b) b.onclick = ()=>loginBtn.click();
        return;
      }

      editBtn.style.opacity = "1";
      editBtn.disabled = false;

      const mine = (reviews && reviews[currentUser.uid]) ? reviews[currentUser.uid] : null;
      if (!mine){
        body.innerHTML = `<div class="myReviewEmpty">Belum ada ulasan. Tap ikon pensil untuk menulis.</div>`;
        return;
      }
      const s = Number(mine.stars || 0);
      const c = String(mine.comment || "");
      body.innerHTML = `
        <div class="myReviewMeta">
          <span>${starsDisplay(s)}</span>
          <span class="ratingNum">${s || "0"}</span>
          <span>•</span>
          <span>${mine.updatedAt ? timeAgo(mine.updatedAt) : ""}</span>
        </div>
        ${c ? `<div class="myReviewText">${escapeHtml(c)}</div>` : `<div class="myReviewEmpty">(Tanpa komentar)</div>`}
      `;
    }

    function setupReviewUI(appId){
      const rateStarsEl = document.getElementById("rateStars");
      const commentBox = document.getElementById("commentBox");
      const submitBtn = document.getElementById("submitReviewBtn");
      const cancelBtn = document.getElementById("cancelEditBtn");
      const hintEl = document.getElementById("reviewHint");
      const charInfo = document.getElementById("charInfo");
      const selectedLabel = document.getElementById("selectedLabel");
      const editBtn = document.getElementById("editReviewBtn");

      let selectedStars = 0;
      const MAX_LEN = 500;

      function updateSelectedLabel(){
        selectedLabel.textContent = selectedStars ? `Rating: ${selectedStars}/5` : "Pilih rating";
      }
      function updateCharInfo(){
        const len = (commentBox.value || "").length;
        charInfo.textContent = `${len}/${MAX_LEN}`;
        if (len > MAX_LEN){
          charInfo.classList.add("danger");
          charInfo.textContent = `${len}/${MAX_LEN} (kepanjangan)`;
        } else charInfo.classList.remove("danger");
      }
      function renderStars(){
        rateStarsEl.innerHTML = "";
        for (let i=1;i<=5;i++){
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "starBtn";
          btn.innerHTML = starSvg(i <= selectedStars);
          btn.onpointerdown = (e)=>{
            e.preventDefault();
            selectedStars = i;
            renderStars();
            updateSelectedLabel();
          };
          rateStarsEl.appendChild(btn);
        }
      }

      async function loadMyExistingReview(){
        if (!currentUser){
          selectedStars = 0;
          commentBox.value = "";
          submitBtn.textContent = "Kirim";
          hintEl.textContent = "Login dulu untuk ulasan.";
          renderStars(); updateSelectedLabel(); updateCharInfo();
          return;
        }
        hintEl.textContent = "Isi lalu Kirim.";

        const mine = await getMyReview(appId);
        if (mine){
          selectedStars = Number(mine.stars || 0);
          commentBox.value = String(mine.comment || "");
          submitBtn.textContent = "Perbarui";
          hintEl.textContent = `Terakhir: ${timeAgo(mine.updatedAt)}`;
        } else {
          selectedStars = 0;
          commentBox.value = "";
          submitBtn.textContent = "Kirim";
        }
        renderStars(); updateSelectedLabel(); updateCharInfo();
      }

      editBtn.onclick = async ()=>{
        if (!currentUser){
          toast("Login dulu untuk ulasan.");
          return;
        }
        await loadMyExistingReview();
        setEditorOpen(true);
        // fokus halus
        setTimeout(()=>commentBox.focus({preventScroll:false}), 50);
      };

      cancelBtn.onclick = ()=>{
        setEditorOpen(false);
      };

      commentBox.addEventListener("input", updateCharInfo);

      submitBtn.onclick = async ()=>{
        if (!currentUser){
          toast("Login dulu untuk ulasan.");
          return;
        }
        if (selectedStars < 1 || selectedStars > 5){
          toast("Pilih rating 1–5 bintang.");
          return;
        }
        const comment = (commentBox.value || "").trim();
        if (comment.length > MAX_LEN){
          toast("Komentar terlalu panjang (max 500).");
          return;
        }
        try{
          await submitReview(appId, selectedStars, comment);
          toast("Ulasan tersimpan.");
          setEditorOpen(false); // ✅ setelah kirim/perbarui, editor hilang
          // summary akan ke-update dari listener
        } catch (e){
          toast("Gagal menyimpan ulasan. Cek Rules.");
          console.error(e);
        }
      };

      renderStars(); updateSelectedLabel(); updateCharInfo();
      setEditorOpen(false);
      _reviewFormCache = { appId, reload: loadMyExistingReview };
    }

    async function refreshReviewForm(appId){
      if (_reviewFormCache && _reviewFormCache.appId === appId){
        await _reviewFormCache.reload();
      }
    }

    function renderReviewsList(appId, reviewsOverride=null){
      const a = appById(appId);
      if (!a) return;

      const list = document.getElementById("reviewsList");
      if (!list) return;

      const reviewsObj = reviewsOverride ?? a.reviews ?? {};
      const entries = Object.entries(reviewsObj)
        .map(([uid,v])=>({
          uid,
          stars: Number(v?.stars || 0),
          comment: String(v?.comment || ""),
          userName: String(v?.userName || "User"),
          userPhoto: String(v?.userPhoto || ""),
          updatedAt: Number(v?.updatedAt || 0),
          like: voteCounts?.[uid]?.like || 0,
          dislike: voteCounts?.[uid]?.dislike || 0,
          score: voteCounts?.[uid]?.score || 0
        }))
        .filter(r=>r.stars>=1 && r.stars<=5);

      // filtering
      let filtered = entries;
      if (reviewFilterStar){
        filtered = entries.filter(r=>r.stars === reviewFilterStar)
          .sort((x,y)=>(y.updatedAt||0)-(x.updatedAt||0)); // newest for star filter
      } else {
        // default: popular by likes (score, then likes, then time)
        filtered = entries.sort((x,y)=>{
          if (y.score !== x.score) return y.score - x.score;
          if (y.like !== x.like) return y.like - x.like;
          return (y.updatedAt||0) - (x.updatedAt||0);
        });
      }

      list.innerHTML = "";
      if (filtered.length === 0){
        list.innerHTML = `<div class="hint">${reviewFilterStar ? "Tidak ada ulasan untuk filter ini." : "Belum ada ulasan. Jadilah yang pertama!"}</div>`;
        return;
      }

      filtered.slice(0, 40).forEach(r=>{
        const my = myVote(r.uid);
        const likeActive = my === 1;
        const dislikeActive = my === -1;

        const div = document.createElement("div");
        div.className = "reviewItem";
        div.innerHTML = `
          <img class="rAvatar" src="${r.userPhoto || "icon/default.png"}" alt="avatar" onerror="this.src='icon/default.png'">
          <div class="rMain">
            <div class="rTop">
              <div style="display:flex;gap:8px;align-items:center;min-width:0;flex-wrap:wrap">
                <div class="rName" title="${escapeHtml(r.userName)}">${escapeHtml(r.userName)}</div>
                <div>${starsDisplay(r.stars)}</div>
              </div>
              <div class="rTime">${r.updatedAt ? timeAgo(r.updatedAt) : ""}</div>
            </div>
            ${r.comment ? `<div class="rComment">${escapeHtml(r.comment)}</div>` : `<div class="hint" style="margin-top:6px">(Tanpa komentar)</div>`}

            <div class="voteRow">
              <button class="voteBtn ${likeActive ? "active":""}" data-v="1" data-ruid="${r.uid}" type="button" aria-label="Like">${iconThumbUp()} <span>${r.like}</span></button>
              <button class="voteBtn ${dislikeActive ? "active":""}" data-v="-1" data-ruid="${r.uid}" type="button" aria-label="Dislike">${iconThumbDown()} <span>${r.dislike}</span></button>
            </div>
          </div>
        `;
        list.appendChild(div);
      });

      // click handler votes (event delegation)
      list.onclick = async (e)=>{
        const btn = e.target.closest(".voteBtn");
        if (!btn) return;
        const v = Number(btn.dataset.v || 0);
        const ruid = String(btn.dataset.ruid || "");
        if (!v || !ruid) return;
        try{
          await setVote(appId, ruid, v);
        } catch (err){
          console.error(err);
          toast("Gagal vote. Cek Rules.");
        }
      };
    }

    // ====== Realtime load ======
    const appsRef = ref(db, "apps");
    onValue(appsRef, (snapshot)=>{
      allApps = normalizeApps(snapshot.val());
      render();

      if (currentAppId && !unsubscribeReviews){
        attachReviewsListener(currentAppId);
      }
    }, (err)=>{
      contentEl.innerHTML = `<div class="state">Gagal load data. Cek Rules / koneksi internet.<br><br><b>${escapeHtml(safeText(err?.message,""))}</b></div>`;
      console.error(err);
    });

    // init UI
    setActiveTabs();
    setActiveNav();
    updateHeaderVisibility();
  </script>
</body>
</html>
