<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APK Download</title>
  <meta name="description" content="Download APK terbaru - realtime, ringan, UI mirip Play Store." />

  <style>
    :root{
      --bg:#f3f5f7;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#00a6ff;
      --brand2:#0ea5e9;
      --good:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --star:#fbbf24;     /* kuning */
      --starOff:#cbd5e1;  /* abu */
      --shadow: 0 10px 25px rgba(15, 23, 42, .08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff;
      box-shadow: 0 6px 18px rgba(2,132,199,.25);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.3px;
      white-space:nowrap;
    }
    .logo-badge{
      width:34px; height:34px;
      border-radius:10px;
      background:rgba(255,255,255,.18);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.25);
    }
    .search-wrap{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.25);
      border-radius:999px;
      padding:10px 12px;
      min-width:0;
    }
    .search input{
      border:none;
      outline:none;
      background:transparent;
      color:#fff;
      width:100%;
      font-size:14px;
    }
    .search input::placeholder{color:rgba(255,255,255,.85)}
    .pill{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.16);
      color:#fff;
      font-size:13px;
      white-space:nowrap;
      user-select:none;
    }

    /* Auth */
    .auth{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }
    .btnAuth{
      border-radius:999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.16);
      color:#fff;
      font-size:13px;
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .btnAuth:hover{filter:brightness(.98)}
    .btnAuth:active{transform:scale(.99)}
    .user{
      display:none;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.16);
      white-space:nowrap;
      max-width:240px;
    }
    .avatar{
      width:26px; height:26px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.3);
      background:rgba(255,255,255,.25);
      object-fit:cover;
      flex:0 0 auto;
    }
    .user .uname{
      font-size:13px;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Page */
    .container{
      max-width:1100px;
      margin:0 auto;
      padding:14px;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin:10px 0 12px;
    }
    .chips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:4px;
      scrollbar-width:thin;
    }
    .chip{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      color:var(--text);
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
      font-weight:700;
    }
    .chip.active{
      border-color:rgba(0,166,255,.45);
      box-shadow: 0 0 0 4px rgba(0,166,255,.14);
    }
    .sort{
      display:flex;
      gap:8px;
      align-items:center;
    }
    select{
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      background:var(--card);
      color:var(--text);
      font-size:13px;
      outline:none;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      grid-column: span 12;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      display:flex;
      gap:12px;
      align-items:center;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .card:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, .10);
    }
    .icon{
      width:64px; height:64px;
      border-radius:16px;
      object-fit:cover;
      border:1px solid var(--line);
      background:#fff;
      flex:0 0 auto;
    }
    .meta{flex:1; min-width:0}
    .name-row{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .name{
      font-weight:900;
      font-size:16px;
      margin:0;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .badges{display:flex; gap:6px; align-items:center; flex:0 0 auto}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      white-space:nowrap;
      font-weight:800;
    }
    .badge.new{border-color:rgba(16,185,129,.4); background:rgba(16,185,129,.08); color:var(--good);}
    .badge.mod{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.10); color:var(--warn);}
    .desc{
      margin:6px 0 8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .subrow{
      display:flex;
      flex-wrap:wrap;
      gap:10px 12px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .dot{opacity:.55}

    .dl-btn{
      flex:0 0 auto;
      text-decoration:none;
      background:var(--brand);
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 12px 20px rgba(0,166,255,.22);
    }
    .dl-btn:hover{filter:brightness(.98)}
    .dl-btn:active{transform:scale(.99)}

    /* Stars (display) */
    .stars{
      display:inline-flex;
      gap:2px;
      transform: translateY(1px);
      align-items:center;
    }
    .stars svg{width:13px;height:13px}
    .stars .on{fill: var(--star)}
    .stars .off{fill: var(--starOff)}
    .ratingNum{font-weight:900; color:var(--text)}

    .state{
      padding:14px;
      border:1px dashed rgba(100,116,139,.35);
      border-radius:14px;
      color:var(--muted);
      background:rgba(255,255,255,.6);
      text-align:center;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      z-index:50;
      padding:16px;
      overflow:auto;
    }
    .overlay.show{display:block}
    .modal{
      max-width:920px;
      margin:34px auto;
      background:var(--card);
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow: 0 25px 60px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modal-top{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
    }
    .xbtn{
      background:#fff;
      border:1px solid var(--line);
      width:40px; height:40px;
      border-radius:12px;
      cursor:pointer;
      display:grid; place-items:center;
      box-shadow: 0 6px 14px rgba(15,23,42,.06);
    }
    .xbtn:active{transform:scale(.99)}
    .modal-body{
      padding:14px;
      display:grid;
      gap:14px;
    }

    .hero{
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    .hero .icon{
      width:86px; height:86px;
      border-radius:22px;
    }
    .hero h2{
      margin:0;
      font-size:20px;
      line-height:1.2;
      font-weight:1000;
    }
    .hero .small{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
    }
    .btn{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .btn.primary{
      background:var(--brand);
      color:#fff;
      border-color:transparent;
      box-shadow: 0 12px 20px rgba(0,166,255,.22);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn.primary:hover{filter:brightness(.98)}
    .btn:active{transform:scale(.99)}

    .kv{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .kv .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.75);
    }
    .kv .k{font-size:12px; color:var(--muted)}
    .kv .v{font-size:14px; font-weight:1000; margin-top:4px}

    .section{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.75);
    }
    .section h3{
      margin:0 0 10px;
      font-size:14px;
      font-weight:1000;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .section p{
      margin:0;
      color:var(--muted);
      line-height:1.5;
      font-size:13px;
      white-space:pre-wrap;
    }

    /* Review UI (Play Store-ish) */
    .reviewHeader{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      justify-content:space-between;
    }
    .reviewSummary{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:13px;
    }
    .reviewForm{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .rateStars{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .starBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:6px;
      border-radius:12px;
      outline:none;
    }
    .starBtn:hover{background:rgba(2,132,199,.06)}
    .starBtn:active{transform:scale(.99)}
    .starBtn svg{width:28px;height:28px}
    .starOn{fill:var(--star)}
    .starOff{fill:var(--starOff)}
    .formRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    textarea{
      width:100%;
      min-height:92px;
      resize:vertical;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      font-size:13px;
      background:#fff;
    }
    textarea:focus{
      box-shadow: 0 0 0 4px rgba(0,166,255,.14);
      border-color: rgba(0,166,255,.35);
    }
    .hint{
      font-size:12px;
      color:var(--muted);
    }
    .danger{color:var(--danger); font-weight:900}

    .reviewsList{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .reviewItem{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .reviewItem .rAvatar{
      width:34px; height:34px;
      border-radius:999px;
      border:1px solid var(--line);
      object-fit:cover;
      background:#fff;
      flex:0 0 auto;
    }
    .reviewItem .rMain{flex:1; min-width:0}
    .reviewItem .rTop{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .reviewItem .rName{
      font-weight:1000;
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 260px;
    }
    .reviewItem .rTime{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .reviewItem .rComment{
      margin-top:6px;
      color:var(--text);
      font-size:13px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(2,6,23,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      z-index:80;
      box-shadow: 0 18px 40px rgba(2,6,23,.35);
      max-width:92vw;
    }
    .toast.show{display:block}

    @media (min-width: 860px){
      .card{grid-column: span 6;}
      .kv{grid-template-columns: repeat(4, minmax(0,1fr));}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="logo" title="APK Download">
        <div class="logo-badge" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M7 7h10v10H7z" stroke="white" stroke-width="2" opacity=".95"/>
            <path d="M9 4h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 14v-6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M9 11h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        APK Download
      </div>

      <div class="search-wrap">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.3-4.3" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="white" stroke-width="2"/>
          </svg>
          <input id="q" type="text" placeholder="Cari aplikasi (capcut, game, editor)..." autocomplete="off"/>
        </div>
        <div id="countPill" class="pill">0 Apps</div>
      </div>

      <div class="auth">
        <button class="btnAuth" id="loginBtn">Login Google</button>

        <div class="user" id="userBox" title="Akun login">
          <img class="avatar" id="userAvatar" alt="avatar" />
          <div class="uname" id="userName">User</div>
        </div>

        <button class="btnAuth" id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="toolbar">
      <div class="chips" id="chips"></div>
      <div class="sort">
        <label for="sort" style="font-size:13px;color:var(--muted);font-weight:900">Sort</label>
        <select id="sort">
          <option value="latest">Terbaru</option>
          <option value="popular">Populer</option>
          <option value="name">Nama (A-Z)</option>
          <option value="rating">Rating</option>
        </select>
      </div>
    </div>

    <div class="grid" id="list">
      <div class="state">Loading aplikasi...</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-top">
        <div class="modal-title" id="modalTitle">Detail</div>
        <button class="xbtn" id="closeBtn" aria-label="Tutup">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6L6 18" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      set
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ✅ Firebase config kamu
    const firebaseConfig = {
      apiKey: "AIzaSyAu--L2T5_o9xLVT09mXFLIcpPuLLWlL1Q",
      authDomain: "aplikasi-percobaan-dbf84.firebaseapp.com",
      databaseURL: "https://aplikasi-percobaan-dbf84-default-rtdb.firebaseio.com",
      projectId: "aplikasi-percobaan-dbf84",
      storageBucket: "aplikasi-percobaan-dbf84.appspot.com",
      messagingSenderId: "52109851315",
      appId: "1:52109851315:web:ba255b74b4ce0500774ec6",
      measurementId: "G-H6WCVTQQEM"
    };

    const $ = (id) => document.getElementById(id);

    // UI refs
    const listEl = $("list");
    const chipsEl = $("chips");
    const qEl = $("q");
    const sortEl = $("sort");
    const overlay = $("overlay");
    const modalBody = $("modalBody");
    const closeBtn = $("closeBtn");
    const toastEl = $("toast");
    const countPill = $("countPill");

    // Auth UI
    const loginBtn = $("loginBtn");
    const logoutBtn = $("logoutBtn");
    const userBox = $("userBox");
    const userAvatar = $("userAvatar");
    const userName = $("userName");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function safeText(v, fallback=""){
      return (typeof v === "string" || typeof v === "number") ? String(v) : fallback;
    }

    function parseDate(v){
      if (!v) return null;
      if (typeof v === "number") return new Date(v);
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }

    function isNew(updatedAt){
      const d = parseDate(updatedAt);
      if (!d) return false;
      const now = new Date();
      const diff = (now - d) / (1000*60*60*24);
      return diff <= 30;
    }

    function fmtDate(updatedAt){
      const d = parseDate(updatedAt);
      if (!d) return "-";
      const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function timeAgo(ts){
      const d = new Date(Number(ts)||0);
      if (!ts || isNaN(d.getTime())) return "";
      const now = Date.now();
      const diff = Math.max(0, now - d.getTime());
      const m = Math.floor(diff/60000);
      if (m < 1) return "baru saja";
      if (m < 60) return `${m} menit lalu`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h} jam lalu`;
      const day = Math.floor(h/24);
      if (day < 30) return `${day} hari lalu`;
      return fmtDate(d.getTime());
    }

    function fmtNum(n){
      const x = Number(n);
      if (!isFinite(x)) return "0";
      if (x >= 1e6) return (x/1e6).toFixed(1).replace(/\.0$/,"")+"M";
      if (x >= 1e3) return (x/1e3).toFixed(1).replace(/\.0$/,"")+"K";
      return String(Math.round(x));
    }

    function starsDisplay(avg){
      const rating = Math.max(0, Math.min(5, Number(avg)||0));
      let html = `<span class="stars" title="Rating ${rating.toFixed(1)}">`;
      for(let i=1;i<=5;i++){
        const on = (i <= Math.round(rating));
        html += `
          <svg viewBox="0 0 24 24" class="${on ? "on":"off"}" aria-hidden="true">
            <path d="M12 17.3l-6.2 3.4 1.5-7L1.9 8.9l7.2-1L12 1.5l2.9 6.4 7.2 1-5.4 4.8 1.5 7z"/>
          </svg>`;
      }
      html += `</span>`;
      return html;
    }

    function starSvg(on){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path fill="${on ? "var(--star)" : "var(--starOff)"}"
            d="M12 17.3l-6.2 3.4 1.5-7L1.9 8.9l7.2-1L12 1.5l2.9 6.4 7.2 1-5.4 4.8 1.5 7z"/>
        </svg>
      `;
    }

    // Firebase init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Auth state
    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;

      if (currentUser){
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-flex";
        userBox.style.display = "inline-flex";

        userName.textContent = currentUser.displayName || "User";
        userAvatar.src = currentUser.photoURL || "";
        userAvatar.style.display = currentUser.photoURL ? "block" : "none";
      } else {
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        userBox.style.display = "none";
      }
    });

    loginBtn.onclick = async () => {
      try{
        await signInWithPopup(auth, provider);
        toast("Login berhasil!");
      } catch (e){
        toast("Login gagal. Cek Authorized domains.");
        console.error(e);
      }
    };

    logoutBtn.onclick = async () => {
      try{
        await signOut(auth);
        toast("Logout berhasil.");
      } catch (e){
        toast("Logout gagal.");
        console.error(e);
      }
    };

    // ===== App listing state =====
    let allApps = [];
    let categories = [];
    let activeCat = "Semua";
    let query = "";
    let sortBy = "latest";

    function computeReviewStats(reviewsObj){
      // reviewsObj: {uid: {stars, comment, updatedAt, userName, userPhoto}}
      if (!reviewsObj || typeof reviewsObj !== "object") return { avg: 0, count: 0 };
      let sum = 0, count = 0;
      for (const uid in reviewsObj){
        const s = Number(reviewsObj[uid]?.stars);
        if (isFinite(s) && s >= 1 && s <= 5){
          sum += s; count += 1;
        }
      }
      return { avg: count ? (sum/count) : 0, count };
    }

    function normalizeApps(raw){
      const arr = [];
      if (!raw || typeof raw !== "object") return arr;

      for(const id of Object.keys(raw)){
        const a = raw[id] || {};
        const reviews = (a.reviews && typeof a.reviews === "object") ? a.reviews : null;
        arr.push({
          id,
          name: safeText(a.name, "Untitled"),
          description: safeText(a.description, ""),
          version: safeText(a.version, ""),
          size: safeText(a.size, ""),
          updatedAt: a.updatedAt ?? null,
          category: safeText(a.category, "Lainnya"),
          developer: safeText(a.developer, ""),
          minAndroid: safeText(a.minAndroid, ""),
          downloads: Number(a.downloads || 0),
          mod: Boolean(a.mod || false),
          icon: safeText(a.icon, "icon/default.png"),
          downloadUrl: safeText(a.downloadUrl, ""),
          changelog: safeText(a.changelog, ""),
          screenshots: Array.isArray(a.screenshots) ? a.screenshots.slice(0, 12) : [],
          reviews
        });
      }
      return arr;
    }

    function buildCategories(){
      const set = new Set(["Semua"]);
      for(const a of allApps){
        if (a.category) set.add(a.category);
      }
      categories = Array.from(set);
      renderChips();
    }

    function renderChips(){
      chipsEl.innerHTML = "";
      for(const c of categories){
        const el = document.createElement("div");
        el.className = "chip" + (c === activeCat ? " active" : "");
        el.textContent = c;
        el.onclick = () => {
          activeCat = c;
          renderChips();
          renderList();
        };
        chipsEl.appendChild(el);
      }
    }

    function matches(a){
      const q = query.trim().toLowerCase();
      const inCat = (activeCat === "Semua") || (a.category === activeCat);
      if (!inCat) return false;
      if (!q) return true;

      const hay = `${a.name} ${a.description} ${a.category} ${a.developer} ${a.version}`.toLowerCase();
      return hay.includes(q);
    }

    function sortApps(arr){
      const copy = arr.slice();
      if (sortBy === "name"){
        copy.sort((x,y)=> x.name.localeCompare(y.name));
      } else if (sortBy === "popular"){
        copy.sort((x,y)=> (y.downloads||0) - (x.downloads||0));
      } else if (sortBy === "rating"){
        copy.sort((x,y)=>{
          const rx = computeReviewStats(x.reviews).avg;
          const ry = computeReviewStats(y.reviews).avg;
          return ry - rx;
        });
      } else {
        copy.sort((x,y)=>{
          const dx = parseDate(x.updatedAt)?.getTime() || 0;
          const dy = parseDate(y.updatedAt)?.getTime() || 0;
          return dy - dx;
        });
      }
      return copy;
    }

    function createCard(a){
      const {avg, count} = computeReviewStats(a.reviews);

      const card = document.createElement("div");
      card.className = "card";

      const img = document.createElement("img");
      img.className = "icon";
      img.alt = a.name;
      img.src = a.icon || "icon/default.png";
      img.onerror = () => { img.src = "icon/default.png"; };

      const meta = document.createElement("div");
      meta.className = "meta";

      const nameRow = document.createElement("div");
      nameRow.className = "name-row";

      const h = document.createElement("h3");
      h.className = "name";
      h.textContent = a.name;

      const badges = document.createElement("div");
      badges.className = "badges";
      if (isNew(a.updatedAt)) {
        const b = document.createElement("span");
        b.className = "badge new";
        b.textContent = "NEW";
        badges.appendChild(b);
      }
      if (a.mod) {
        const b = document.createElement("span");
        b.className = "badge mod";
        b.textContent = "MOD";
        badges.appendChild(b);
      }

      nameRow.appendChild(h);
      nameRow.appendChild(badges);

      const desc = document.createElement("div");
      desc.className = "desc";
      desc.textContent = a.description || "-";

      const sub = document.createElement("div");
      sub.className = "subrow";
      sub.innerHTML = `
        <span>${starsDisplay(avg)}</span>
        <span class="ratingNum">${avg ? avg.toFixed(1) : "0.0"}</span>
        <span>(${count})</span>
        <span class="dot">•</span>
        <span>${a.version ? "v"+a.version : "-"}</span>
        <span class="dot">•</span>
        <span>Updated ${fmtDate(a.updatedAt)}</span>
        <span class="dot">•</span>
        <span>${fmtNum(a.downloads)} downloads</span>
      `;

      meta.appendChild(nameRow);
      meta.appendChild(desc);
      meta.appendChild(sub);

      const btn = document.createElement("a");
      btn.className = "dl-btn";
      btn.href = a.downloadUrl || "#";
      btn.target = "_blank";
      btn.rel = "noopener";
      btn.textContent = "Download";
      btn.onclick = (e) => {
        if (!a.downloadUrl) {
          e.preventDefault();
          toast("Link download belum diisi.");
          return;
        }
        e.stopPropagation(); // supaya klik tombol tidak buka modal
      };

      card.appendChild(img);
      card.appendChild(meta);
      card.appendChild(btn);

      card.onclick = () => openDetail(a.id);

      return card;
    }

    function renderList(){
      const filtered = allApps.filter(matches);
      const sorted = sortApps(filtered);

      countPill.textContent = `${sorted.length} Apps`;
      listEl.innerHTML = "";

      if (sorted.length === 0){
        const empty = document.createElement("div");
        empty.className = "state";
        empty.textContent = "Tidak ada hasil. Coba kata kunci lain atau pilih kategori 'Semua'.";
        listEl.appendChild(empty);
        return;
      }

      for(const a of sorted){
        listEl.appendChild(createCard(a));
      }
    }

    // ===== Detail + Review (rating + comment) =====
    let currentAppId = null;

    async function getMyReview(appId){
      if (!currentUser) return null;
      const uid = currentUser.uid;
      const snap = await get(ref(db, `apps/${appId}/reviews/${uid}`));
      return snap.exists() ? snap.val() : null;
    }

    async function submitReview(appId, stars, comment){
      if (!currentUser){
        toast("Login dulu untuk ulasan.");
        return;
      }
      const uid = currentUser.uid;
      const reviewRef = ref(db, `apps/${appId}/reviews/${uid}`);

      const payload = {
        stars: Number(stars),
        comment: String(comment || ""),
        userName: currentUser.displayName || "User",
        userPhoto: currentUser.photoURL || "",
        updatedAt: Date.now()
      };

      await set(reviewRef, payload);
      toast("Ulasan tersimpan!");
    }

    function openDetail(id){
      const a = allApps.find(x => x.id === id);
      if (!a) return;

      currentAppId = id;

      const url = new URL(location.href);
      url.searchParams.set("id", id);
      history.replaceState({}, "", url);

      const {avg, count} = computeReviewStats(a.reviews);

      const shotsHtml = (a.screenshots && a.screenshots.length)
        ? `<div class="section">
             <h3>Screenshots</h3>
             <div style="display:flex;gap:10px;overflow:auto;padding-bottom:4px">
               ${a.screenshots.map(s => `<img style="width:180px;height:110px;border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#fff" src="${s}" alt="screenshot" onerror="this.style.display='none'">`).join("")}
             </div>
           </div>`
        : "";

      modalBody.innerHTML = `
        <div class="hero">
          <img class="icon" src="${a.icon || "icon/default.png"}" alt="${a.name}" onerror="this.src='icon/default.png'">
          <div style="min-width:0">
            <h2>${a.name}</h2>
            <div class="small">
              <span>${starsDisplay(avg)}</span>
              <span class="ratingNum">${avg ? avg.toFixed(1) : "0.0"}</span>
              <span>(${count} ulasan)</span>
              <span style="opacity:.6">•</span>
              <span>${a.category || "Lainnya"}</span>
              <span style="opacity:.6">•</span>
              <span>Updated ${fmtDate(a.updatedAt)}</span>
              ${a.mod ? `<span class="badge mod">MOD</span>` : ``}
              ${isNew(a.updatedAt) ? `<span class="badge new">NEW</span>` : ``}
            </div>

            <div class="actions">
              <a class="btn primary" href="${a.downloadUrl || "#"}" target="_blank" rel="noopener" ${a.downloadUrl ? "" : "onclick='return false;'"}>
                ⬇ Download APK
              </a>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn" id="copyLinkBtn">Copy Link</button>
                <button class="btn" id="shareBtn">Share</button>
              </div>
            </div>
          </div>
        </div>

        <div class="kv">
          <div class="box"><div class="k">Version</div><div class="v">${a.version || "-"}</div></div>
          <div class="box"><div class="k">Size</div><div class="v">${a.size || "-"}</div></div>
          <div class="box"><div class="k">Min Android</div><div class="v">${a.minAndroid || "-"}</div></div>
          <div class="box"><div class="k">Downloads</div><div class="v">${fmtNum(a.downloads)}</div></div>
        </div>

        <div class="section" id="reviewSection">
          <div class="reviewHeader">
            <h3 style="margin:0">Ratings & reviews</h3>
            <div class="reviewSummary" id="reviewSummary">
              <span>${starsDisplay(avg)}</span>
              <span class="ratingNum" id="avgNum">${avg ? avg.toFixed(1) : "0.0"}</span>
              <span id="reviewCount">(${count})</span>
            </div>
          </div>

          <div class="reviewForm">
            <div class="rateStars" id="rateStars"></div>
<div class="hint" id="selectedLabel">Belum memilih rating</div>

            <textarea id="commentBox" placeholder="Tulis ulasan kamu (opsional)..."></textarea>

            <div class="formRow">
              <div class="hint" id="reviewHint">Pilih bintang, tulis ulasan, lalu klik Kirim.</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <button class="btn" id="reviewLoginBtn" style="display:none;">Login untuk Ulasan</button>
                <button class="btn primary" id="submitReviewBtn">Kirim</button>
              </div>
            </div>

            <div class="hint">
              1 akun Google = 1 ulasan. Kamu bisa <b>Perbarui</b> ulasan kapan saja.
              <span id="charInfo" class="hint"></span>
            </div>
          </div>

          <div class="reviewsList" id="reviewsList"></div>
        </div>

        <div class="section">
          <h3>Deskripsi</h3>
          <p>${(a.description || "-")}</p>
        </div>

        ${a.changelog ? `
          <div class="section">
            <h3>Changelog</h3>
            <p>${a.changelog}</p>
          </div>
        ` : ""}

        ${shotsHtml}
      `;

      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");

      // share/copy
      const copyBtn = document.getElementById("copyLinkBtn");
      const shareBtn = document.getElementById("shareBtn");
      const shareUrl = location.href;

      copyBtn.onclick = async () => {
        try{
          await navigator.clipboard.writeText(shareUrl);
          toast("Link berhasil di-copy!");
        } catch {
          toast("Gagal copy. Coba manual.");
        }
      };

      shareBtn.onclick = async () => {
        if (navigator.share){
          try{
            await navigator.share({ title: a.name, text: "Download APK", url: shareUrl });
          } catch {}
        } else {
          toast("Browser belum support Share. Pakai Copy Link.");
        }
      };

      // review logic
      setupReviewUI(id);
      renderReviewsList(id);
    }

    function closeDetail(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      const url = new URL(location.href);
      url.searchParams.delete("id");
      history.replaceState({}, "", url);
      currentAppId = null;
    }

    closeBtn.onclick = closeDetail;
    overlay.addEventListener("click", (e)=>{
      if (e.target === overlay) closeDetail();
    });
    window.addEventListener("keydown",(e)=>{
      if (e.key === "Escape") closeDetail();
    });

    // Search debounce
    let t = null;
    qEl.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(()=>{
        query = qEl.value || "";
        renderList();
      }, 120);
    });

    sortEl.addEventListener("change", ()=>{
      sortBy = sortEl.value;
      renderList();
    });

    // ===== Review UI =====
    function setupReviewUI(appId){
  const rateStarsEl = document.getElementById("rateStars");
  const commentBox = document.getElementById("commentBox");
  const submitBtn = document.getElementById("submitReviewBtn");
  const loginReviewBtn = document.getElementById("reviewLoginBtn");
  const hintEl = document.getElementById("reviewHint");
  const charInfo = document.getElementById("charInfo");
  const selectedLabel = document.getElementById("selectedLabel");

  let selectedStars = 0;     // ✅ hanya berubah saat klik/tap
  const MAX_LEN = 500;

  function updateSelectedLabel(){
    if (!selectedLabel) return;
    selectedLabel.textContent = selectedStars
      ? `Rating dipilih: ${selectedStars}/5`
      : "Belum memilih rating";
  }

  function updateCharInfo(){
    const len = (commentBox.value || "").length;
    if (!charInfo) return;
    charInfo.textContent = ` • ${len}/${MAX_LEN}`;
    if (len > MAX_LEN){
      charInfo.classList.add("danger");
      charInfo.textContent = ` • ${len}/${MAX_LEN} (kepanjangan)`;
    } else {
      charInfo.classList.remove("danger");
    }
  }

  function renderStars(){
    rateStarsEl.innerHTML = "";
    for (let i=1;i<=5;i++){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "starBtn";
      btn.innerHTML = starSvg(i <= selectedStars);

      // ✅ pointerdown biar di HP sekali tap langsung kepilih
      btn.onpointerdown = (e) => {
        e.preventDefault();
        selectedStars = i;
        renderStars();
        updateSelectedLabel();
      };

      rateStarsEl.appendChild(btn);
    }
  }

  async function loadMyExistingReview(){
    if (!currentUser){
      selectedStars = 0;
      commentBox.value = "";
      submitBtn.textContent = "Kirim";
      hintEl.textContent = "Login untuk memberi ulasan.";
      loginReviewBtn.style.display = "inline-flex";
      renderStars();
      updateSelectedLabel();
      updateCharInfo();
      return;
    }

    loginReviewBtn.style.display = "none";
    hintEl.textContent = "Pilih bintang, tulis ulasan, lalu klik Kirim.";

    const mine = await getMyReview(appId);
    if (mine){
      selectedStars = Number(mine.stars || 0);
      commentBox.value = String(mine.comment || "");
      submitBtn.textContent = "Perbarui";
      hintEl.textContent = `Ulasan kamu terakhir diupdate: ${timeAgo(mine.updatedAt)}`;
    } else {
      selectedStars = 0;
      commentBox.value = "";
      submitBtn.textContent = "Kirim";
    }

    renderStars();
    updateSelectedLabel();
    updateCharInfo();
  }

  loginReviewBtn.onclick = async () => {
    try{
      await signInWithPopup(auth, provider);
      toast("Login berhasil!");
      await loadMyExistingReview();
    } catch (e){
      toast("Login gagal. Cek Authorized domains.");
      console.error(e);
    }
  };

  commentBox.addEventListener("input", updateCharInfo);

  submitBtn.onclick = async () => {
    if (!currentUser){
      toast("Login dulu untuk ulasan.");
      loginReviewBtn.style.display = "inline-flex";
      return;
    }
    if (selectedStars < 1 || selectedStars > 5){
      toast("Pilih rating 1–5 bintang dulu (klik bintangnya).");
      return;
    }
    const comment = (commentBox.value || "").trim();
    if (comment.length > MAX_LEN){
      toast("Komentar terlalu panjang (max 500).");
      return;
    }

    try{
      await submitReview(appId, selectedStars, comment);
      submitBtn.textContent = "Perbarui";
      hintEl.textContent = "Ulasan tersimpan. Kamu bisa perbarui kapan saja.";
      renderReviewsList(appId);
    } catch (e){
      toast("Gagal menyimpan ulasan.");
      console.error(e);
    }
  };

  renderStars();
  updateSelectedLabel();
  updateCharInfo();
  loadMyExistingReview();

  // kalau login/logout saat modal terbuka, refresh form
  onAuthStateChanged(auth, async () => {
    if (currentAppId === appId){
      await loadMyExistingReview();
    }
  });
}


    function renderReviewsList(appId){
      const a = allApps.find(x => x.id === appId);
      if (!a) return;

      const list = document.getElementById("reviewsList");
      const avgNum = document.getElementById("avgNum");
      const reviewCount = document.getElementById("reviewCount");

      if (!list || !avgNum || !reviewCount) return;

      const reviewsObj = a.reviews || {};
      const entries = Object.entries(reviewsObj)
        .map(([uid, v]) => ({
          uid,
          stars: Number(v?.stars || 0),
          comment: String(v?.comment || ""),
          userName: String(v?.userName || "User"),
          userPhoto: String(v?.userPhoto || ""),
          updatedAt: Number(v?.updatedAt || 0)
        }))
        .filter(r => r.stars >= 1 && r.stars <= 5)
        .sort((x,y) => (y.updatedAt||0) - (x.updatedAt||0));

      const stats = computeReviewStats(reviewsObj);
      avgNum.textContent = stats.avg ? stats.avg.toFixed(1) : "0.0";
      reviewCount.textContent = `(${stats.count})`;

      list.innerHTML = "";

      if (entries.length === 0){
        list.innerHTML = `<div class="hint">Belum ada ulasan. Jadilah yang pertama!</div>`;
        return;
      }

      // Tampilkan maksimal 20 ulasan terbaru
      const shown = entries.slice(0, 20);

      for (const r of shown){
        const div = document.createElement("div");
        div.className = "reviewItem";
        div.innerHTML = `
          <img class="rAvatar" src="${r.userPhoto || "icon/default.png"}" alt="avatar" onerror="this.src='icon/default.png'">
          <div class="rMain">
            <div class="rTop">
              <div style="display:flex;gap:8px;align-items:center;min-width:0;flex-wrap:wrap">
                <div class="rName" title="${r.userName}">${r.userName}</div>
                <div>${starsDisplay(r.stars)}</div>
              </div>
              <div class="rTime">${r.updatedAt ? timeAgo(r.updatedAt) : ""}</div>
            </div>
            ${r.comment ? `<div class="rComment">${escapeHtml(r.comment)}</div>` : `<div class="hint" style="margin-top:6px;">(Tanpa komentar)</div>`}
          </div>
        `;
        list.appendChild(div);
      }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Load apps realtime
    const appsRef = ref(db, "apps");
    onValue(appsRef, (snapshot)=>{
      const raw = snapshot.val();
      allApps = normalizeApps(raw);
      buildCategories();
      renderList();

      // update modal review list live if open
      if (currentAppId){
        renderReviewsList(currentAppId);
      }

      // auto open detail if ?id=...
      const url = new URL(location.href);
      const id = url.searchParams.get("id");
      if (id && !currentAppId) openDetail(id);
    }, (err)=>{
      listEl.innerHTML = `<div class="state">Gagal load data. Cek Rules / koneksi internet.<br><br><b>${safeText(err?.message,"")}</b></div>`;
      console.error(err);
    });
  </script>
</body>
</html>
