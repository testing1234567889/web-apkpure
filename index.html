<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APK Download</title>
  <meta name="description" content="Download APK terbaru - cepat, ringan, dan realtime." />

  <style>
    :root{
      --bg:#f3f5f7;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#00a6ff;
      --brand2:#0ea5e9;
      --good:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 10px 25px rgba(15, 23, 42, .08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff;
      box-shadow: 0 6px 18px rgba(2,132,199,.25);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.3px;
      white-space:nowrap;
    }
    .logo-badge{
      width:34px; height:34px;
      border-radius:10px;
      background:rgba(255,255,255,.18);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.25);
    }
    .logo svg{display:block}
    .search-wrap{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.25);
      border-radius:999px;
      padding:10px 12px;
      min-width:0;
    }
    .search input{
      border:none;
      outline:none;
      background:transparent;
      color:#fff;
      width:100%;
      font-size:14px;
    }
    .search input::placeholder{color:rgba(255,255,255,.85)}
    .pill{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.16);
      color:#fff;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pill:active{transform:scale(.99)}
    .container{
      max-width:1100px;
      margin:0 auto;
      padding:14px;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin:10px 0 12px;
    }
    .chips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:4px;
      scrollbar-width:thin;
    }
    .chip{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      color:var(--text);
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
    }
    .chip.active{
      border-color:rgba(0,166,255,.45);
      box-shadow: 0 0 0 4px rgba(0,166,255,.14);
    }
    .sort{
      display:flex;
      gap:8px;
      align-items:center;
    }
    select{
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      background:var(--card);
      color:var(--text);
      font-size:13px;
      outline:none;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      grid-column: span 12;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      display:flex;
      gap:12px;
      align-items:center;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .card:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, .10);
    }
    .icon{
      width:64px; height:64px;
      border-radius:16px;
      object-fit:cover;
      border:1px solid var(--line);
      background:#fff;
      flex:0 0 auto;
    }
    .meta{flex:1; min-width:0}
    .name-row{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .name{
      font-weight:800;
      font-size:16px;
      margin:0;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .badges{display:flex; gap:6px; align-items:center; flex:0 0 auto}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.new{border-color:rgba(16,185,129,.4); background:rgba(16,185,129,.08); color:var(--good); font-weight:700;}
    .badge.mod{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.10); color:var(--warn); font-weight:700;}
    .desc{
      margin:6px 0 8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .subrow{
      display:flex;
      flex-wrap:wrap;
      gap:10px 12px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .dot{opacity:.5}
    .dl-btn{
      flex:0 0 auto;
      text-decoration:none;
      background:var(--brand);
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 12px 20px rgba(0,166,255,.22);
    }
    .dl-btn:hover{filter:brightness(.98)}
    .dl-btn:active{transform:scale(.99)}
    .stars{
      display:inline-flex;
      gap:2px;
      transform: translateY(1px);
    }
    .stars svg{width:13px;height:13px}
    .stars .on{fill: #fbbf24}
    .stars .off{fill: #e5e7eb}

    .state{
      padding:14px;
      border:1px dashed rgba(100,116,139,.35);
      border-radius:14px;
      color:var(--muted);
      background:rgba(255,255,255,.6);
      text-align:center;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      z-index:50;
      padding:16px;
      overflow:auto;
    }
    .overlay.show{display:block}
    .modal{
      max-width:820px;
      margin:40px auto;
      background:var(--card);
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow: 0 25px 60px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modal-top{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
    }
    .xbtn{
      background:transparent;
      border:1px solid var(--line);
      width:38px; height:38px;
      border-radius:12px;
      cursor:pointer;
      display:grid; place-items:center;
    }
    .modal-body{
      padding:14px;
      display:grid;
      gap:14px;
    }
    .hero{
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    .hero .icon{
      width:84px; height:84px; border-radius:20px;
    }
    .hero h2{
      margin:0;
      font-size:20px;
      line-height:1.2;
    }
    .hero .small{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .kv{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .kv .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.75);
    }
    .kv .k{font-size:12px; color:var(--muted)}
    .kv .v{font-size:14px; font-weight:800; margin-top:4px}
    .section{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.75);
    }
    .section h3{
      margin:0 0 8px;
      font-size:14px;
    }
    .section p{
      margin:0;
      color:var(--muted);
      line-height:1.5;
      font-size:13px;
      white-space:pre-wrap;
    }
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .btn{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .btn.primary{
      background:var(--brand);
      color:#fff;
      border-color:transparent;
      box-shadow: 0 12px 20px rgba(0,166,255,.22);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn.primary:hover{filter:brightness(.98)}
    .btn:active{transform:scale(.99)}
    .shots{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:4px;
    }
    .shot{
      width:180px; height:110px;
      border-radius:14px;
      object-fit:cover;
      border:1px solid var(--line);
      background:#fff;
      flex:0 0 auto;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(2,6,23,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      z-index:80;
      box-shadow: 0 18px 40px rgba(2,6,23,.35);
      max-width:92vw;
    }
    .toast.show{display:block}

    @media (min-width: 860px){
      .card{grid-column: span 6;}
      .kv{grid-template-columns: repeat(4, minmax(0,1fr));}
    }
  </style>
</head>

<body>
  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="logo" title="APK Download">
        <div class="logo-badge" aria-hidden="true">
          <!-- simple icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M7 7h10v10H7z" stroke="white" stroke-width="2" opacity=".95"/>
            <path d="M9 4h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 14v-6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M9 11h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        APK Download
      </div>

      <div class="search-wrap">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.3-4.3" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="white" stroke-width="2"/>
          </svg>
          <input id="q" type="text" placeholder="Cari aplikasi (contoh: capcut, game, editor)..." autocomplete="off"/>
        </div>
        <div id="countPill" class="pill" title="Jumlah aplikasi">0 Apps</div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="chips" id="chips"></div>
      <div class="sort">
        <label for="sort" style="font-size:13px;color:var(--muted)">Sort</label>
        <select id="sort">
          <option value="latest">Terbaru</option>
          <option value="popular">Populer</option>
          <option value="name">Nama (A-Z)</option>
          <option value="rating">Rating</option>
        </select>
      </div>
    </div>

    <!-- List -->
    <div class="grid" id="list">
      <div class="state">Loading aplikasi...</div>
    </div>

    <div style="height:18px"></div>
    <div class="state" style="display:none" id="hint">
      Tip: icon bisa pakai folder GitHub kamu, contoh <b>icon/capcut.png</b>. Screenshot opsional di field <b>screenshots</b>.
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-top">
        <div class="modal-title" id="modalTitle">Detail</div>
        <button class="xbtn" id="closeBtn" aria-label="Tutup">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6L6 18" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ✅ config dari kamu
    const firebaseConfig = {
      apiKey: "AIzaSyAu--L2T5_o9xLVT09mXFLIcpPuLLWlL1Q",
      authDomain: "aplikasi-percobaan-dbf84.firebaseapp.com",
      databaseURL: "https://aplikasi-percobaan-dbf84-default-rtdb.firebaseio.com",
      projectId: "aplikasi-percobaan-dbf84",
      storageBucket: "aplikasi-percobaan-dbf84.appspot.com",
      messagingSenderId: "52109851315",
      appId: "1:52109851315:web:ba255b74b4ce0500774ec6",
      measurementId: "G-H6WCVTQQEM"
    };

    const $ = (id) => document.getElementById(id);

    const listEl = $("list");
    const chipsEl = $("chips");
    const qEl = $("q");
    const sortEl = $("sort");
    const overlay = $("overlay");
    const modalBody = $("modalBody");
    const closeBtn = $("closeBtn");
    const toastEl = $("toast");
    const countPill = $("countPill");
    const hintEl = $("hint");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function safeText(v, fallback=""){
      return (typeof v === "string" || typeof v === "number") ? String(v) : fallback;
    }

    function parseDate(v){
      if (!v) return null;
      if (typeof v === "number") return new Date(v);
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }

    function isNew(updatedAt){
      const d = parseDate(updatedAt);
      if (!d) return false;
      const now = new Date();
      const diff = (now - d) / (1000*60*60*24);
      return diff <= 30; // NEW jika <= 30 hari terakhir
    }

    function fmtDate(updatedAt){
      const d = parseDate(updatedAt);
      if (!d) return "-";
      const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function fmtNum(n){
      const x = Number(n);
      if (!isFinite(x)) return "-";
      if (x >= 1e6) return (x/1e6).toFixed(1).replace(/\.0$/,"")+"M";
      if (x >= 1e3) return (x/1e3).toFixed(1).replace(/\.0$/,"")+"K";
      return String(Math.round(x));
    }

    function stars(r){
      const rating = Math.max(0, Math.min(5, Number(r)||0));
      const full = Math.round(rating * 2) / 2; // 0.5 steps visual-ish
      let html = `<span class="stars" title="Rating ${full}">`;
      for(let i=1;i<=5;i++){
        const on = (i <= full);
        html += `
          <svg viewBox="0 0 24 24" class="${on ? "on":"off"}" aria-hidden="true">
            <path d="M12 17.3l-6.2 3.4 1.5-7L1.9 8.9l7.2-1L12 1.5l2.9 6.4 7.2 1-5.4 4.8 1.5 7z"/>
          </svg>`;
      }
      html += `</span>`;
      return html;
    }

    // State
    let allApps = [];     // normalized array
    let categories = [];  // strings
    let activeCat = "Semua";
    let query = "";
    let sortBy = "latest";

    function normalizeApps(raw){
      // raw: object {id: {...}}
      const arr = [];
      if (!raw || typeof raw !== "object") return arr;

      for(const id of Object.keys(raw)){
        const a = raw[id] || {};
        arr.push({
          id,
          name: safeText(a.name, "Untitled"),
          description: safeText(a.description, ""),
          version: safeText(a.version, ""),
          size: safeText(a.size, ""),
          updatedAt: a.updatedAt ?? a.updateAt ?? a.updated ?? null,
          category: safeText(a.category, "Lainnya"),
          developer: safeText(a.developer, ""),
          minAndroid: safeText(a.minAndroid, ""),
          downloads: Number(a.downloads || 0),
          rating: Number(a.rating || 0),
          mod: Boolean(a.mod || a.isMod || false),
          icon: safeText(a.icon, "icon/default.png"),
          downloadUrl: safeText(a.downloadUrl, ""),
          changelog: safeText(a.changelog, ""),
          screenshots: Array.isArray(a.screenshots) ? a.screenshots.slice(0, 12) : [],
        });
      }
      return arr;
    }

    function buildCategories(){
      const set = new Set(["Semua"]);
      for(const a of allApps){
        if (a.category) set.add(a.category);
      }
      categories = Array.from(set);
      renderChips();
    }

    function renderChips(){
      chipsEl.innerHTML = "";
      for(const c of categories){
        const el = document.createElement("div");
        el.className = "chip" + (c === activeCat ? " active" : "");
        el.textContent = c;
        el.onclick = () => {
          activeCat = c;
          renderChips();
          renderList();
        };
        chipsEl.appendChild(el);
      }
    }

    function matches(a){
      const q = query.trim().toLowerCase();
      const inCat = (activeCat === "Semua") || (a.category === activeCat);
      if (!inCat) return false;
      if (!q) return true;

      const hay = `${a.name} ${a.description} ${a.category} ${a.developer} ${a.version}`.toLowerCase();
      return hay.includes(q);
    }

    function sortApps(arr){
      const copy = arr.slice();
      if (sortBy === "name"){
        copy.sort((x,y)=> x.name.localeCompare(y.name));
      } else if (sortBy === "popular"){
        copy.sort((x,y)=> (y.downloads||0) - (x.downloads||0));
      } else if (sortBy === "rating"){
        copy.sort((x,y)=> (y.rating||0) - (x.rating||0));
      } else { // latest
        copy.sort((x,y)=>{
          const dx = parseDate(x.updatedAt)?.getTime() || 0;
          const dy = parseDate(y.updatedAt)?.getTime() || 0;
          return dy - dx;
        });
      }
      return copy;
    }

    function createCard(a){
      const card = document.createElement("div");
      card.className = "card";
      card.setAttribute("data-id", a.id);

      const img = document.createElement("img");
      img.className = "icon";
      img.alt = a.name;
      img.src = a.icon || "icon/default.png";
      img.onerror = () => { img.src = "icon/default.png"; };

      const meta = document.createElement("div");
      meta.className = "meta";

      const nameRow = document.createElement("div");
      nameRow.className = "name-row";

      const h = document.createElement("h3");
      h.className = "name";
      h.textContent = a.name;

      const badges = document.createElement("div");
      badges.className = "badges";

      if (isNew(a.updatedAt)) {
        const b = document.createElement("span");
        b.className = "badge new";
        b.textContent = "NEW";
        badges.appendChild(b);
      }
      if (a.mod) {
        const b = document.createElement("span");
        b.className = "badge mod";
        b.textContent = "MOD";
        badges.appendChild(b);
      }

      nameRow.appendChild(h);
      nameRow.appendChild(badges);

      const desc = document.createElement("div");
      desc.className = "desc";
      desc.textContent = a.description || "-";

      const sub = document.createElement("div");
      sub.className = "subrow";
      sub.innerHTML = `
        <span>${stars(a.rating)}</span>
        <span class="dot">•</span>
        <span>${safeText(a.version,"-") ? "v"+safeText(a.version,"-") : "-"}</span>
        <span class="dot">•</span>
        <span>Updated ${fmtDate(a.updatedAt)}</span>
        <span class="dot">•</span>
        <span>${fmtNum(a.downloads)} downloads</span>
      `;

      meta.appendChild(nameRow);
      meta.appendChild(desc);
      meta.appendChild(sub);

      const btn = document.createElement("a");
      btn.className = "dl-btn";
      btn.href = a.downloadUrl || "#";
      btn.target = "_blank";
      btn.rel = "noopener";
      btn.textContent = "Download";
      btn.onclick = (e) => {
        if (!a.downloadUrl) {
          e.preventDefault();
          toast("Link download belum diisi.");
          return;
        }
        // biar klik tombol tidak buka modal
        e.stopPropagation();
      };

      card.appendChild(img);
      card.appendChild(meta);
      card.appendChild(btn);

      // klik card = buka detail
      card.onclick = () => openDetail(a.id);

      return card;
    }

    function renderList(){
      const filtered = allApps.filter(matches);
      const sorted = sortApps(filtered);

      countPill.textContent = `${sorted.length} Apps`;
      listEl.innerHTML = "";

      if (sorted.length === 0){
        const empty = document.createElement("div");
        empty.className = "state";
        empty.textContent = "Tidak ada hasil. Coba kata kunci lain atau pilih kategori 'Semua'.";
        listEl.appendChild(empty);
        return;
      }

      for(const a of sorted){
        listEl.appendChild(createCard(a));
      }
    }

    function openDetail(id){
      const a = allApps.find(x => x.id === id);
      if (!a) return;

      // update url (shareable)
      const url = new URL(location.href);
      url.searchParams.set("id", id);
      history.replaceState({}, "", url);

      const shotsHtml = (a.screenshots && a.screenshots.length)
        ? `<div class="section">
             <h3>Screenshots</h3>
             <div class="shots">
               ${a.screenshots.map(s => `<img class="shot" src="${s}" alt="screenshot" onerror="this.style.display='none'">`).join("")}
             </div>
           </div>`
        : "";

      modalBody.innerHTML = `
        <div class="hero">
          <img class="icon" src="${a.icon || "icon/default.png"}" alt="${a.name}" onerror="this.src='icon/default.png'">
          <div style="min-width:0">
            <h2>${a.name}</h2>
            <div class="small">
              <span>${stars(a.rating)}</span>
              <span style="opacity:.6">•</span>
              <span>${a.category || "Lainnya"}</span>
              <span style="opacity:.6">•</span>
              <span>Updated ${fmtDate(a.updatedAt)}</span>
              ${a.mod ? `<span class="badge mod">MOD</span>` : ``}
              ${isNew(a.updatedAt) ? `<span class="badge new">NEW</span>` : ``}
            </div>

            <div class="actions" style="margin-top:12px">
              <a class="btn primary" href="${a.downloadUrl || "#"}" target="_blank" rel="noopener" ${a.downloadUrl ? "" : "onclick='return false;'"}>
                ⬇ Download APK
              </a>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn" id="copyLinkBtn">Copy Link</button>
                <button class="btn" id="shareBtn">Share</button>
              </div>
            </div>
          </div>
        </div>

        <div class="kv">
          <div class="box"><div class="k">Version</div><div class="v">${a.version || "-"}</div></div>
          <div class="box"><div class="k">Size</div><div class="v">${a.size || "-"}</div></div>
          <div class="box"><div class="k">Min Android</div><div class="v">${a.minAndroid || "-"}</div></div>
          <div class="box"><div class="k">Downloads</div><div class="v">${fmtNum(a.downloads)}</div></div>
        </div>

        <div class="section">
          <h3>Deskripsi</h3>
          <p>${(a.description || "-")}</p>
        </div>

        ${a.changelog ? `
          <div class="section">
            <h3>Changelog</h3>
            <p>${a.changelog}</p>
          </div>
        ` : ""}

        ${shotsHtml}
      `;

      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");

      // buttons
      const copyBtn = document.getElementById("copyLinkBtn");
      const shareBtn = document.getElementById("shareBtn");

      const shareUrl = location.href;
      copyBtn.onclick = async () => {
        try{
          await navigator.clipboard.writeText(shareUrl);
          toast("Link berhasil di-copy!");
        } catch {
          toast("Gagal copy. Coba manual.");
        }
      };

      shareBtn.onclick = async () => {
        if (navigator.share){
          try{
            await navigator.share({ title: a.name, text: "Download APK", url: shareUrl });
          } catch {}
        } else {
          toast("Browser belum support Share. Pakai Copy Link.");
        }
      };
    }

    function closeDetail(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      // remove id param
      const url = new URL(location.href);
      url.searchParams.delete("id");
      history.replaceState({}, "", url);
    }

    closeBtn.onclick = closeDetail;
    overlay.addEventListener("click", (e)=>{
      if (e.target === overlay) closeDetail();
    });
    window.addEventListener("keydown",(e)=>{
      if (e.key === "Escape") closeDetail();
    });

    // Search debounce
    let t = null;
    qEl.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(()=>{
        query = qEl.value || "";
        renderList();
      }, 120);
    });

    sortEl.addEventListener("change", ()=>{
      sortBy = sortEl.value;
      renderList();
    });

    // Firebase init
    try{
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // apps data
      const appsRef = ref(db, "apps");

      onValue(appsRef, (snapshot)=>{
        const raw = snapshot.val();
        allApps = normalizeApps(raw);

        hintEl.style.display = allApps.length ? "block" : "none";
        buildCategories();
        renderList();

        // auto open detail if ?id=...
        const url = new URL(location.href);
        const id = url.searchParams.get("id");
        if (id) openDetail(id);
      }, (err)=>{
        listEl.innerHTML = `<div class="state">Gagal load data. Cek Rules / koneksi internet.<br><br><b>${safeText(err?.message,"")}</b></div>`;
      });

    } catch (e){
      listEl.innerHTML = `<div class="state">Firebase init error: ${safeText(e?.message,"")}</div>`;
    }
  </script>
</body>
</html>
