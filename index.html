<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>APK Store</title>
  <meta name="description" content="APK Store — UI ala Play Store: Apps & Games, kategori scroll, detail + rating & komentar (1 user 1 ulasan)." />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#1a73e8;
      --brand2:#0b57d0;
      --good:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --star:#fbbf24;
      --starOff:#cbd5e1;
      --shadow: 0 10px 25px rgba(15, 23, 42, .07);
      --radius:16px;
      --safeT: env(safe-area-inset-top);
      --safeB: env(safe-area-inset-bottom);
      --safeL: env(safe-area-inset-left);
      --safeR: env(safe-area-inset-right);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    a{color:inherit;text-decoration:none}
    button, input, textarea, select{font:inherit}

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px;
      padding-left: calc(14px + var(--safeL));
      padding-right: calc(14px + var(--safeR));
    }

    /* ===== Header ===== */
    .header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(246,247,251,.84);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(229,231,235,.7);
    }
    .header-inner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 10px 14px 10px;
      padding-top: calc(10px + var(--safeT));
      padding-left: calc(14px + var(--safeL));
      padding-right: calc(14px + var(--safeR));
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand .mark{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      display:grid;place-items:center;
      box-shadow: 0 10px 20px rgba(26,115,232,.2);
      flex:0 0 auto;
    }
    .brand .title{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .auth{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .btnAuth{
      height:38px;
      border-radius:999px;
      padding:0 12px;
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      font-size:13px;
      font-weight:900;
      cursor:pointer;
    }
    .btnAuth.primary{
      background: var(--brand);
      border-color: transparent;
      color:#fff;
      box-shadow: 0 10px 18px rgba(26,115,232,.18);
    }
    .btnAuth:active{transform:scale(.99)}

    /* avatar-only in header (no name, no logout) */
    .avatarBtn{
      width:40px;height:40px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      display:none;
      place-items:center;
      cursor:pointer;
      padding:0;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      overflow:hidden;
    }
    .avatarBtn img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
    }
    .avatarBtn:active{transform:scale(.99)}

    .searchBar{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .searchBar svg{flex:0 0 auto;opacity:.75}
    .searchBar input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:16px; /* iOS anti-zoom */
    }
    .pill{
      font-size:12px;
      font-weight:900;
      color: var(--muted);
      white-space:nowrap;
    }

    .tabs{
      display:flex;
      gap:14px;
      align-items:flex-end;
      overflow:auto;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      position:relative;
      padding: 8px 2px;
      font-weight:1000;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .tab.active{color: var(--text)}
    .tab.active:after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:3px;
      border-radius:999px;
      background: var(--brand);
    }

    .subcatsRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .subcats{
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom: 2px;
      scrollbar-width:thin;
      -webkit-overflow-scrolling: touch;
      flex: 1;
      min-width:0;
    }
    .chip{
      height:36px;
      border-radius: 999px;
      padding: 0 12px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .chip.active{
      border-color: rgba(26,115,232,.45);
      box-shadow: 0 0 0 4px rgba(26,115,232,.12);
    }

    .sortPill{
      height:36px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--card);
      padding: 0 10px;
      font-weight:1000;
      color: var(--text);
      display:flex;
      align-items:center;
      gap: 8px;
      flex:0 0 auto;
      box-shadow: 0 10px 18px rgba(15,23,42,.04);
    }
    .sortPill select{
      border:none;
      outline:none;
      background:transparent;
      font-weight:1000;
      cursor:pointer;
      padding: 0 2px;
      font-size:13px;
    }

    /* ===== Bottom nav ===== */
    .bottomNav{
      position: sticky;
      bottom: 0;
      z-index: 40;
      background: rgba(246,247,251,.90);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(229,231,235,.75);
      padding-bottom: var(--safeB);
    }
    .bottomNav-inner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 8px 14px;
      padding-left: calc(14px + var(--safeL));
      padding-right: calc(14px + var(--safeR));
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    .navBtn{
      border:none;
      background:transparent;
      border-radius: 14px;
      padding: 8px 6px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-weight:900;
      font-size:11px;
      min-height: 44px;
    }
    .navBtn.active{
      color: var(--brand2);
      background: rgba(26,115,232,.10);
    }
    .navBtn:active{transform:scale(.99)}
    .navBtn svg{width:20px;height:20px}

    /* ===== Content ===== */
    .content{
      min-height: calc(100vh - 210px);
      padding-bottom: 14px;
    }
    .state{
      padding: 14px;
      border: 1px dashed rgba(100,116,139,.35);
      border-radius: 16px;
      color: var(--muted);
      background: rgba(255,255,255,.6);
      text-align:center;
    }

    .section{ margin-top: 14px; }
    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .sectionTitle{
      font-weight:1000;
      font-size:15px;
    }
    .linkBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
      color: var(--brand2);
      padding: 6px 10px;
      border-radius: 999px;
    }
    .linkBtn:hover{background: rgba(26,115,232,.08)}
    .linkBtn:active{transform:scale(.99)}

    .hscroll{
      display:flex;
      gap: 10px;
      overflow:auto;
      padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
    }
    .tile{
      scroll-snap-align: start;
      min-width: 220px;
      max-width: 220px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 12px;
      cursor:pointer;
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }
    .tile:active{transform:scale(.995)}
    .ico{
      width: 56px; height:56px;
      border-radius: 16px;
      border: 1px solid var(--line);
      object-fit:cover;
      background:#fff;
      flex:0 0 auto;
    }
    .tileMain{min-width:0; flex:1}
    .tileName{
      font-weight:1000;
      font-size:14px;
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      margin:0;
    }
    .tileMeta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
      color: var(--muted);
      font-size:12px;
    }

    /* Vertical list (Top/search) */
    .vlist{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .rowCard{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 12px;
      cursor:pointer;
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .rowMain{min-width:0; flex:1}
    .rowTitle{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .rowName{
      font-weight:1000;
      font-size:15px;
      margin:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;
      color: var(--muted);
      font-weight:1000;
      white-space:nowrap;
    }
    .badge.new{border-color:rgba(16,185,129,.4); background:rgba(16,185,129,.08); color:var(--good);}
    .badge.mod{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.10); color:var(--warn);}
    .rowDesc{
      margin-top:6px;
      color: var(--muted);
      font-size:13px;
      line-height:1.4;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .rowMeta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap: 10px 12px;
      align-items:center;
      color: var(--muted);
      font-size:12px;
    }
    .btnInstall{
      height: 40px;
      border-radius: 999px;
      padding: 0 14px;
      border: 1px solid var(--line);
      background: var(--brand);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(26,115,232,.16);
      white-space:nowrap;
      flex:0 0 auto;
      min-height: 44px;
    }
    .btnInstall:active{transform:scale(.99)}

    /* Stars */
    .stars{display:inline-flex;gap:2px;align-items:center;transform: translateY(1px)}
    .stars svg{width:13px;height:13px}
    .on{fill: var(--star)}
    .off{fill: var(--starOff)}
    .ratingNum{font-weight:1000;color: var(--text)}

    /* ===== Modal ===== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.56);
      display:none;
      z-index: 80;
      padding: 14px;
      padding-bottom: calc(14px + var(--safeB));
      padding-left: calc(14px + var(--safeL));
      padding-right: calc(14px + var(--safeR));
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .overlay.show{display:block}
    .modal{
      width: min(960px, 100%);
      margin: 32px auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(2,6,23,.38);
      overflow:hidden;
    }
    .modalTop{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modalTitle{
      font-weight:1000;
      font-size:14px;
      color: var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    .xbtn{
      width: 42px; height: 42px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background:#fff;
      cursor:pointer;
      display:grid; place-items:center;
      box-shadow: 0 10px 20px rgba(15,23,42,.06);
    }
    .xbtn:active{transform:scale(.99)}
    .modalBody{
      padding: 14px;
      display:grid;
      gap: 14px;
      max-height: calc(100dvh - 140px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    @supports not (height: 100dvh){
      .modalBody{max-height: calc(100vh - 140px)}
    }

    .hero{ display:flex; gap: 14px; align-items:flex-start; }
    .hero .ico{ width: 86px; height: 86px; border-radius: 22px; }
    .hero h2{ margin:0; font-size: 20px; line-height:1.15; font-weight: 1000; }
    .heroSmall{
      margin-top: 8px;
      color: var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      font-size: 13px;
    }
    .actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }
    .btn{
      height: 42px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight: 1000;
      font-size: 13px;
      min-height: 44px;
    }
    .btn.primary{
      background: var(--brand);
      border-color: transparent;
      color:#fff;
      box-shadow: 0 10px 18px rgba(26,115,232,.18);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:active{transform:scale(.99)}

    .kv{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    .kv .box{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(255,255,255,.8);
    }
    .kv .k{color:var(--muted); font-size:12px}
    .kv .v{margin-top:4px; font-weight:1000; font-size:14px}

    .panel{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.8);
    }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .panelHead h3{
      margin:0;
      font-size: 14px;
      font-weight: 1000;
    }
    .panel p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
      white-space: pre-wrap;
    }

    .shots{
      display:flex;
      gap: 10px;
      overflow:auto;
      padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
    }
    .shot{
      width: 190px; height: 118px;
      border-radius: 16px;
      border: 1px solid var(--line);
      object-fit: cover;
      background:#fff;
      scroll-snap-align: start;
      flex:0 0 auto;
    }

    /* Reviews */
    .reviewSummary{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 13px;
    }
    .reviewGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .reviewStats{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 12px;
      align-items:center;
    }
    .bigRating{
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:flex-start;
    }
    .bigRating .num{font-size:36px;font-weight:1000;line-height:1}
    .bars{ display:grid; gap: 6px; }
    .barRow{
      display:grid;
      grid-template-columns: 20px 1fr 34px;
      gap: 8px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    .bar{
      height: 8px;
      border-radius: 999px;
      background: rgba(100,116,139,.18);
      overflow:hidden;
      position:relative;
    }
    .bar > span{
      position:absolute; left:0; top:0; bottom:0;
      width: 0%;
      background: var(--brand);
      border-radius: 999px;
    }

    .rateStars{
      display:flex;
      gap: 6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .starBtn{
      border:none;
      background:transparent;
      padding: 6px;
      border-radius: 14px;
      cursor:pointer;
      touch-action: manipulation;
    }
    .starBtn:hover{background: rgba(26,115,232,.08)}
    .starBtn svg{width: 30px; height: 30px}
    .hint{color: var(--muted); font-size: 12px}
    textarea{
      width:100%;
      min-height: 92px;
      resize: vertical;
      border-radius: 16px;
      border: 1px solid var(--line);
      padding: 10px 12px;
      outline:none;
      font-size: 14px;
      background:#fff;
    }
    textarea:focus{
      border-color: rgba(26,115,232,.35);
      box-shadow: 0 0 0 4px rgba(26,115,232,.12);
    }
    .danger{color: var(--danger); font-weight:1000}

    .reviewsList{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    .reviewItem{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }
    .rAvatar{
      width: 36px; height: 36px;
      border-radius: 999px;
      border: 1px solid var(--line);
      object-fit: cover;
      background:#fff;
      flex:0 0 auto;
    }
    .rMain{min-width:0; flex:1}
    .rTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      flex-wrap:wrap;
    }
    .rName{
      font-weight:1000;
      font-size: 13px;
      max-width: 260px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .rTime{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .rComment{
      margin-top: 6px;
      font-size: 13px;
      line-height: 1.45;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Profile */
    .profileCard{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .pAvatar{
      width:54px;height:54px;border-radius:999px;
      border:1px solid var(--line);
      object-fit:cover;background:#fff;
      flex:0 0 auto;
    }
    .pMain{min-width:0;flex:1}
    .pName{
      font-weight:1000;
      font-size:16px;
      margin:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pEmail{
      margin-top:4px;
      color: var(--muted);
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Desktop tweaks */
    @media (min-width: 860px){
      .kv{grid-template-columns: repeat(4, minmax(0,1fr));}
      .reviewGrid{grid-template-columns: 1fr 1fr;}
    }

    /* Bottom sheet on small screens */
    @media (max-width: 560px){
      .overlay{display:none}
      .overlay.show{
        display:flex;
        align-items:flex-end;
      }
      .modal{
        margin: 0;
        width: 100%;
        border-radius: 22px 22px 0 0;
      }
      .modalBody{ max-height: calc(100dvh - 90px); }
      .tile{min-width: 200px; max-width: 200px;}
      .hero{flex-direction: column;}
      .hero .ico{width: 74px; height: 74px; border-radius: 18px;}
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-inner">
      <div class="topRow">
        <div class="brand" title="APK Store">
          <div class="mark" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M7 7h10v10H7z" stroke="white" stroke-width="2" opacity=".95"/>
              <path d="M9 4h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 14v-6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M9 11h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="title">APK Store</div>
        </div>

        <div class="auth">
          <button class="btnAuth primary" id="loginBtn">Login Google</button>
          <button class="avatarBtn" id="avatarBtn" aria-label="Buka profil">
            <img id="headerAvatar" alt="profil">
          </button>
        </div>
      </div>

      <div class="searchBar" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 21l-4.3-4.3" stroke="#0f172a" stroke-width="2" stroke-linecap="round" opacity=".85"/>
          <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#0f172a" stroke-width="2" opacity=".85"/>
        </svg>
        <input id="q" type="text" placeholder="Cari aplikasi atau game..." inputmode="search" enterkeyhint="search" autocapitalize="off" autocomplete="off" />
        <div id="countPill" class="pill">0</div>
      </div>

      <div class="tabs" id="mainTabs" aria-label="Tabs">
        <div class="tab active" data-tab="apps">Aplikasi</div>
        <div class="tab" data-tab="games">Game</div>
      </div>

      <div class="subcatsRow">
        <div class="subcats" id="subcats" aria-label="Kategori"></div>
        <div class="sortPill" title="Urutkan daftar">
          <span style="font-size:12px;color:var(--muted);font-weight:1000">Sort</span>
          <select id="sortSelect" aria-label="Sort">
            <option value="popular">Populer</option>
            <option value="rating">Rating</option>
            <option value="latest">Terbaru</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap content">
    <div id="content">
      <div class="state">Loading data...</div>
    </div>
  </main>

  <nav class="bottomNav" aria-label="Navigasi">
    <div class="bottomNav-inner">
      <button class="navBtn active" data-page="home" id="navHome">
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
        Home
      </button>
      <button class="navBtn" data-page="top" id="navTop">
        <svg viewBox="0 0 24 24" fill="none"><path d="M6 21V10m6 11V3m6 18v-8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Top
      </button>
      <button class="navBtn" data-page="profile" id="navProfile">
        <svg viewBox="0 0 24 24" fill="none"><path d="M20 21a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2"/></svg>
        Profil
      </button>
    </div>
  </nav>

  <!-- Detail modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">Detail</div>
        <button class="xbtn" id="closeBtn" aria-label="Tutup">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6 6 18" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div id="toast" style="
    position:fixed;left:50%;bottom:calc(18px + var(--safeB));transform:translateX(-50%);
    background:rgba(2,6,23,.92);color:#fff;padding:10px 12px;border-radius:999px;
    font-size:13px;display:none;z-index:90;box-shadow:0 18px 40px rgba(2,6,23,.35);
    max-width:92vw;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      set
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ====== Firebase config ======
    const firebaseConfig = {
      apiKey: "AIzaSyAu--L2T5_o9xLVT09mXFLIcpPuLLWlL1Q",
      authDomain: "aplikasi-percobaan-dbf84.firebaseapp.com",
      databaseURL: "https://aplikasi-percobaan-dbf84-default-rtdb.firebaseio.com",
      projectId: "aplikasi-percobaan-dbf84",
      storageBucket: "aplikasi-percobaan-dbf84.appspot.com",
      messagingSenderId: "52109851315",
      appId: "1:52109851315:web:ba255b74b4ce0500774ec6",
      measurementId: "G-H6WCVTQQEM"
    };

    // ====== Helpers ======
    const $ = (id)=>document.getElementById(id);
    const contentEl = $("content");
    const qEl = $("q");
    const countPill = $("countPill");
    const subcatsEl = $("subcats");
    const overlay = $("overlay");
    const modalBody = $("modalBody");
    const modalTitle = $("modalTitle");
    const closeBtn = $("closeBtn");
    const toastEl = $("toast");
    const sortSelect = $("sortSelect");

    const loginBtn = $("loginBtn");
    const avatarBtn = $("avatarBtn");
    const headerAvatar = $("headerAvatar");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.style.display="none", 1800);
    }
    function safeText(v, fallback=""){ return (typeof v === "string" || typeof v === "number") ? String(v) : fallback; }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function parseDate(v){
      if (!v) return null;
      if (typeof v === "number") return new Date(v);
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }
    function fmtDate(v){
      const d = parseDate(v);
      if (!d) return "-";
      const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }
    function timeAgo(ts){
      const d = new Date(Number(ts)||0);
      if (!ts || isNaN(d.getTime())) return "";
      const diff = Math.max(0, Date.now() - d.getTime());
      const m = Math.floor(diff/60000);
      if (m < 1) return "baru saja";
      if (m < 60) return `${m} menit lalu`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h} jam lalu`;
      const day = Math.floor(h/24);
      if (day < 30) return `${day} hari lalu`;
      return fmtDate(d.getTime());
    }
    function fmtNum(n){
      const x = Number(n);
      if (!isFinite(x)) return "0";
      if (x >= 1e6) return (x/1e6).toFixed(1).replace(/\\.0$/,"")+"M";
      if (x >= 1e3) return (x/1e3).toFixed(1).replace(/\\.0$/,"")+"K";
      return String(Math.round(x));
    }
    function isNew(updatedAt){
      const d = parseDate(updatedAt);
      if (!d) return false;
      const diff = (Date.now() - d.getTime()) / (1000*60*60*24);
      return diff <= 30;
    }
    function starsDisplay(avg){
      const rating = Math.max(0, Math.min(5, Number(avg)||0));
      let html = `<span class="stars" title="Rating ${rating.toFixed(1)}">`;
      for(let i=1;i<=5;i++){
        const on = (i <= Math.round(rating));
        html += `
          <svg viewBox="0 0 24 24" class="${on ? "on":"off"}" aria-hidden="true">
            <path d="M12 17.3l-6.2 3.4 1.5-7L1.9 8.9l7.2-1L12 1.5l2.9 6.4 7.2 1-5.4 4.8 1.5 7z"/>
          </svg>`;
      }
      html += `</span>`;
      return html;
    }
    function starSvg(on){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path fill="${on ? "var(--star)" : "var(--starOff)"}"
            d="M12 17.3l-6.2 3.4 1.5-7L1.9 8.9l7.2-1L12 1.5l2.9 6.4 7.2 1-5.4 4.8 1.5 7z"/>
        </svg>
      `;
    }

    function computeReviewStats(reviewsObj){
      if (!reviewsObj || typeof reviewsObj !== "object") return { avg: 0, count: 0, dist:[0,0,0,0,0] };
      let sum = 0, count = 0;
      const dist = [0,0,0,0,0];
      for (const uid in reviewsObj){
        const s = Number(reviewsObj[uid]?.stars);
        if (isFinite(s) && s >= 1 && s <= 5){
          sum += s; count += 1;
          dist[s-1] += 1;
        }
      }
      return { avg: count ? (sum/count) : 0, count, dist };
    }

    // ====== Firebase init ======
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ====== State ======
    let currentUser = null;
    let allApps = [];
    let currentAppId = null;

    const state = {
      tab: "apps",          // "apps" | "games"
      category: "Semua",
      page: "home",         // home|top|profile
      query: "",
      sort: "popular"       // popular|rating|latest
    };

    function typeOfApp(a){
      const t = String(a.type || "").toLowerCase().trim();
      if (t === "game" || t === "games") return "games";
      if (t === "app" || t === "apps") return "apps";
      const cat = String(a.category || "").toLowerCase();
      if (cat.includes("game") || cat.includes("games")) return "games";
      return "apps";
    }

    function normalizeApps(raw){
      const arr = [];
      if (!raw || typeof raw !== "object") return arr;
      for(const id of Object.keys(raw)){
        const a = raw[id] || {};
        arr.push({
          id,
          type: safeText(a.type, ""),
          name: safeText(a.name, "Untitled"),
          description: safeText(a.description, ""),
          version: safeText(a.version, ""),
          size: safeText(a.size, ""),
          updatedAt: a.updatedAt ?? null,
          category: safeText(a.category, "Lainnya"),
          developer: safeText(a.developer, ""),
          minAndroid: safeText(a.minAndroid, ""),
          downloads: Number(a.downloads || 0),
          mod: Boolean(a.mod || false),
          icon: safeText(a.icon, "icon/default.png"),
          downloadUrl: safeText(a.downloadUrl, ""),
          changelog: safeText(a.changelog, ""),
          screenshots: Array.isArray(a.screenshots) ? a.screenshots.slice(0, 12) : [],
          reviews: (a.reviews && typeof a.reviews === "object") ? a.reviews : null
        });
      }
      return arr;
    }

    // ====== Auth ======
    onAuthStateChanged(auth, (user)=>{
      currentUser = user || null;
      if (currentUser){
        loginBtn.style.display = "none";
        avatarBtn.style.display = "grid";
        headerAvatar.src = currentUser.photoURL || "icon/default.png";
      } else {
        loginBtn.style.display = "inline-flex";
        avatarBtn.style.display = "none";
      }

      if (currentAppId) refreshReviewForm(currentAppId);
      if (state.page === "profile") render();
    });

    loginBtn.onclick = async ()=>{
      try{
        await signInWithPopup(auth, provider);
        toast("Login berhasil!");
      } catch (e){
        toast("Login gagal. Cek Authorized domains.");
        console.error(e);
      }
    };

    avatarBtn.onclick = ()=>{
      state.page = "profile";
      setActiveNav();
      render();
      window.scrollTo({top:0, behavior:"smooth"});
    };

    // ====== Tabs + Nav ======
    document.getElementById("mainTabs").addEventListener("click",(e)=>{
      const tab = e.target?.dataset?.tab;
      if (!tab) return;
      state.tab = tab;
      state.category = "Semua";
      state.page = "home";
      setActiveTabs();
      setActiveNav();
      render();
    });

    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.page = btn.dataset.page;
        setActiveNav();
        render();
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });

    function setActiveTabs(){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab === state.tab);
      });
    }
    function setActiveNav(){
      document.querySelectorAll(".navBtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.page === state.page);
      });
    }

    // ===== Sort =====
    sortSelect.value = state.sort;
    sortSelect.addEventListener("change", ()=>{
      state.sort = sortSelect.value;
      render();
    });

    // ====== Categories (chips) ======
    function buildCategoriesForTab(){
      const cats = new Map(); // cat -> count
      for (const a of allApps){
        if (typeOfApp(a) !== state.tab) continue;
        const c = a.category || "Lainnya";
        cats.set(c, (cats.get(c)||0)+1);
      }
      // Semuanya dulu, lalu urut by count desc
      const list = Array.from(cats.entries())
        .sort((x,y)=>y[1]-x[1])
        .map(([c])=>c);

      return ["Semua", ...list];
    }

    function renderSubcats(){
      const cats = buildCategoriesForTab();
      subcatsEl.innerHTML = "";
      for (const c of cats){
        const btn = document.createElement("button");
        btn.className = "chip" + (c === state.category ? " active" : "");
        btn.textContent = c;
        btn.onclick = ()=>{
          state.category = c;
          renderSubcats();
          // tetap home supaya “kategori” kerasa
          state.page = "home";
          setActiveNav();
          render();
        };
        subcatsEl.appendChild(btn);
      }
    }

    // ====== Search ======
    let t = null;
    qEl.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(()=>{
        state.query = qEl.value || "";
        state.page = "home";
        setActiveNav();
        render();
      }, 120);
    });

    function matchesQuery(a){
      const q = state.query.trim().toLowerCase();
      if (!q) return true;
      const hay = `${a.name} ${a.description} ${a.category} ${a.developer} ${a.version}`.toLowerCase();
      return hay.includes(q);
    }
    function matchesTabAndCat(a){
      if (typeOfApp(a) !== state.tab) return false;
      if (state.category === "Semua") return true;
      return a.category === state.category;
    }
    function filteredApps(){
      return allApps.filter(a=>matchesTabAndCat(a) && matchesQuery(a));
    }

    function sortItems(items){
      const copy = items.slice();
      if (state.sort === "latest"){
        return copy.sort((x,y)=>{
          const dx = parseDate(x.updatedAt)?.getTime() || 0;
          const dy = parseDate(y.updatedAt)?.getTime() || 0;
          return dy - dx;
        });
      }
      if (state.sort === "rating"){
        return copy.sort((x,y)=>{
          const rx = computeReviewStats(x.reviews).avg;
          const ry = computeReviewStats(y.reviews).avg;
          // tie-breaker: downloads
          if (ry !== rx) return ry - rx;
          return (Number(y.downloads||0)-Number(x.downloads||0));
        });
      }
      // popular
      return copy.sort((x,y)=>(Number(y.downloads||0)-Number(x.downloads||0)));
    }

    // ====== UI components ======
    function createTile(a){
      const {avg} = computeReviewStats(a.reviews);
      const div = document.createElement("div");
      div.className = "tile";
      div.onclick = ()=>openDetail(a.id);
      div.innerHTML = `
        <img class="ico" src="${a.icon || "icon/default.png"}" alt="${escapeHtml(a.name)}" onerror="this.src='icon/default.png'">
        <div class="tileMain">
          <p class="tileName">${escapeHtml(a.name)}</p>
          <div class="tileMeta">
            <span>${starsDisplay(avg)}</span>
            <span class="ratingNum">${avg ? avg.toFixed(1) : "0.0"}</span>
            <span>•</span>
            <span>${escapeHtml(a.category || "Lainnya")}</span>
          </div>
        </div>
      `;
      return div;
    }

    function createRowCard(a, idx=null){
      const {avg, count} = computeReviewStats(a.reviews);
      const card = document.createElement("div");
      card.className = "rowCard";
      card.onclick = ()=>openDetail(a.id);

      const badges = [];
      if (isNew(a.updatedAt)) badges.push(`<span class="badge new">NEW</span>`);
      if (a.mod) badges.push(`<span class="badge mod">MOD</span>`);

      const rank = (idx !== null) ? `<span class="badge" style="margin-right:6px">#${idx+1}</span>` : ``;

      card.innerHTML = `
        <img class="ico" src="${a.icon || "icon/default.png"}" alt="${escapeHtml(a.name)}" onerror="this.src='icon/default.png'">
        <div class="rowMain">
          <div class="rowTitle">
            <h3 class="rowName">${rank}${escapeHtml(a.name)}</h3>
            <div style="display:flex;gap:6px;align-items:center">${badges.join("")}</div>
          </div>
          <div class="rowDesc">${escapeHtml(a.description || "-")}</div>
          <div class="rowMeta">
            <span>${starsDisplay(avg)}</span>
            <span class="ratingNum">${avg ? avg.toFixed(1) : "0.0"}</span>
            <span>(${count})</span>
            <span>•</span>
            <span>${fmtNum(a.downloads)} download</span>
            <span>•</span>
            <span>Update ${fmtDate(a.updatedAt)}</span>
          </div>
        </div>
        <button class="btnInstall" type="button">Install</button>
      `;

      const btn = card.querySelector(".btnInstall");
      btn.onclick = (e)=>{
        e.stopPropagation();
        if (!a.downloadUrl){
          toast("Link download belum diisi.");
          return;
        }
        window.open(a.downloadUrl, "_blank", "noopener");
      };

      return card;
    }

    function sectionBlock(title, items, onSeeAll){
      const section = document.createElement("section");
      section.className = "section";
      const head = document.createElement("div");
      head.className = "sectionHead";
      head.innerHTML = `
        <div class="sectionTitle">${escapeHtml(title)}</div>
        ${onSeeAll ? `<button class="linkBtn" type="button">Lihat semua</button>` : ``}
      `;
      if (onSeeAll){
        head.querySelector("button").onclick = onSeeAll;
      }

      const row = document.createElement("div");
      row.className = "hscroll";
      for(const a of items){
        row.appendChild(createTile(a));
      }

      section.appendChild(head);
      section.appendChild(row);
      return section;
    }

    // ====== Pages ======
    function renderHome(){
      const apps = filteredApps();
      countPill.textContent = `${apps.length}`;
      contentEl.innerHTML = "";

      // Search: list vertical
      if (state.query.trim()){
        const box = document.createElement("div");
        box.className = "section";
        box.innerHTML = `<div class="sectionHead"><div class="sectionTitle">Hasil pencarian</div><div class="pill">Sort: ${labelSort()}</div></div>`;
        const vlist = document.createElement("div");
        vlist.className = "vlist";
        if (apps.length === 0){
          vlist.innerHTML = `<div class="state">Tidak ada hasil. Coba kata kunci lain.</div>`;
        } else {
          sortItems(apps).slice(0, 80).forEach((a,i)=>vlist.appendChild(createRowCard(a, null)));
        }
        box.appendChild(vlist);
        contentEl.appendChild(box);
        return;
      }

      if (apps.length === 0){
        contentEl.innerHTML = `<div class="state">Belum ada data di tab ini. Tambahkan data di RTDB: <b>apps/{appId}</b></div>`;
        return;
      }

      // HOME ala Play Store: tampil per kategori (Tools, Entertainment, Offline, dll)
      const catsAll = buildCategoriesForTab().filter(c=>c!=="Semua");
      let catsToShow = catsAll;

      if (state.category !== "Semua"){
        catsToShow = [state.category].filter(Boolean);
      } else {
        // tampilkan maksimal 8 kategori teratas (by count)
        catsToShow = catsAll.slice(0, 8);
      }

      // header kecil info sorting di kanan (bukan section populer/rating terpisah)
      const info = document.createElement("div");
      info.className = "sectionHead";
      info.style.marginTop = "6px";
      info.innerHTML = `<div class="sectionTitle">Kategori</div><div class="pill">Sort: ${labelSort()}</div>`;
      contentEl.appendChild(info);

      // render tiap kategori sebagai row horizontal
      for (const c of catsToShow){
        const items = allApps
          .filter(a=>typeOfApp(a)===state.tab && (c ? a.category===c : true))
          .filter(a=>matchesQuery(a)); // query kosong tapi aman
        const sorted = sortItems(items);
        if (sorted.length === 0) continue;

        contentEl.appendChild(sectionBlock(c, sorted.slice(0, 12), ()=>{
          state.page = "top";
          setActiveNav();
          // set filter ke kategori ini
          state.category = c;
          renderSubcats();
          render();
        }));
      }

      // kalau kategorinya banyak, kasih tombol “lihat semua” ke Top
      if (state.category === "Semua" && catsAll.length > 8){
        const more = document.createElement("div");
        more.className = "section";
        more.innerHTML = `
          <div class="state">
            Banyak kategori lainnya (${catsAll.length}).<br>
            Buka tab <b>Top</b> untuk lihat daftar lengkap.
          </div>
        `;
        contentEl.appendChild(more);
      }
    }

    function labelSort(){
      if (state.sort === "latest") return "Terbaru";
      if (state.sort === "rating") return "Rating";
      return "Populer";
    }

    function renderTop(){
      const apps = sortItems(filteredApps());
      countPill.textContent = `${apps.length}`;
      contentEl.innerHTML = "";

      const head = document.createElement("div");
      head.className = "sectionHead";
      head.innerHTML = `
        <div class="sectionTitle">Top ${state.tab === "games" ? "Game" : "Aplikasi"}</div>
        <div class="pill">${state.category === "Semua" ? "Semua kategori" : escapeHtml(state.category)} • Sort: ${labelSort()}</div>
      `;
      contentEl.appendChild(head);

      const vlist = document.createElement("div");
      vlist.className = "vlist";
      if (apps.length === 0){
        vlist.innerHTML = `<div class="state">Tidak ada data.</div>`;
      } else {
        apps.slice(0, 120).forEach((a,i)=>vlist.appendChild(createRowCard(a, i)));
      }
      contentEl.appendChild(vlist);
    }

    async function renderProfile(){
      contentEl.innerHTML = "";
      countPill.textContent = "";

      const panel = document.createElement("div");
      panel.className = "panel";

      if (!currentUser){
        panel.innerHTML = `
          <div class="panelHead"><h3>Profil</h3><span class="badge">Guest</span></div>
          <p>Kamu belum login. Login untuk bisa kasih rating & komentar (1 akun = 1 ulasan).</p>
          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn primary" id="pLogin">Login Google</button>
          </div>
        `;
        contentEl.appendChild(panel);
        panel.querySelector("#pLogin").onclick = ()=>loginBtn.click();
        return;
      }

      panel.innerHTML = `
        <div class="panelHead"><h3>Profil</h3><span class="badge">Login</span></div>

        <div class="profileCard">
          <img class="pAvatar" src="${currentUser.photoURL || "icon/default.png"}" alt="avatar" onerror="this.src='icon/default.png'">
          <div class="pMain">
            <p class="pName">${escapeHtml(currentUser.displayName || "User")}</p>
            <div class="pEmail">${escapeHtml(currentUser.email || "-")}</div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn" id="pHow">Cara isi data</button>
          <button class="btn primary" id="pLogout">Logout</button>
        </div>

        <div style="margin-top:12px" class="hint">
          1 akun Google = 1 ulasan per item. Kamu bisa <b>perbarui</b> ulasan kapan saja.
        </div>
      `;
      contentEl.appendChild(panel);

      panel.querySelector("#pLogout").onclick = async ()=>{
        try{
          await signOut(auth);
          toast("Logout berhasil.");
        } catch (e){
          toast("Logout gagal.");
          console.error(e);
        }
      };
      panel.querySelector("#pHow").onclick = ()=>{
        toast("Data di RTDB: apps/{appId} (name, icon, category, type, downloadUrl, ...)");
      };

      // My reviews list
      const myUid = currentUser.uid;
      const mine = allApps
        .filter(a => a.reviews && a.reviews[myUid])
        .map(a => {
          const r = a.reviews[myUid];
          return {
            app: a,
            stars: Number(r?.stars || 0),
            updatedAt: Number(r?.updatedAt || 0),
            comment: String(r?.comment || "")
          };
        })
        .sort((x,y)=>(y.updatedAt||0)-(x.updatedAt||0));

      const panel2 = document.createElement("div");
      panel2.className = "panel";
      panel2.style.marginTop = "14px";
      panel2.innerHTML = `
        <div class="panelHead"><h3>Ulasan Saya</h3><span class="badge">${mine.length} item</span></div>
        <div id="myReviews"></div>
      `;
      contentEl.appendChild(panel2);

      const box = panel2.querySelector("#myReviews");
      if (mine.length === 0){
        box.innerHTML = `<div class="hint">Kamu belum kasih ulasan ke item mana pun.</div>`;
      } else {
        const list = document.createElement("div");
        list.className = "vlist";
        mine.slice(0, 30).forEach((x)=>{
          const a = x.app;
          const card = document.createElement("div");
          card.className = "rowCard";
          card.onclick = ()=>openDetail(a.id);
          card.innerHTML = `
            <img class="ico" src="${a.icon || "icon/default.png"}" alt="${escapeHtml(a.name)}" onerror="this.src='icon/default.png'">
            <div class="rowMain">
              <div class="rowTitle">
                <h3 class="rowName">${escapeHtml(a.name)}</h3>
                <span class="badge">${timeAgo(x.updatedAt)}</span>
              </div>
              <div class="rowMeta">
                <span>${starsDisplay(x.stars)}</span>
                <span class="ratingNum">${x.stars ? x.stars.toFixed(0) : "0"}</span>
                <span>•</span>
                <span>${escapeHtml(a.category || "Lainnya")}</span>
              </div>
              <div class="rowDesc">${escapeHtml(x.comment || "(Tanpa komentar)")}</div>
            </div>
          `;
          list.appendChild(card);
        });
        box.appendChild(list);
      }
    }

    function render(){
      renderSubcats();

      // URL params: ?id=...
      const url = new URL(location.href);
      const idParam = url.searchParams.get("id");
      if (idParam && !currentAppId){
        openDetail(idParam);
      }

      if (state.page === "top") return renderTop();
      if (state.page === "profile") return renderProfile();
      return renderHome();
    }

    // ====== Detail + Reviews (1 user 1 ulasan) ======
    async function getMyReview(appId){
      if (!currentUser) return null;
      const uid = currentUser.uid;
      const snap = await get(ref(db, `apps/${appId}/reviews/${uid}`));
      return snap.exists() ? snap.val() : null;
    }

    async function submitReview(appId, stars, comment){
      if (!currentUser){
        toast("Login dulu untuk ulasan.");
        return;
      }
      const uid = currentUser.uid;
      const reviewRef = ref(db, `apps/${appId}/reviews/${uid}`);
      const payload = {
        stars: Number(stars),
        comment: String(comment || ""),
        userName: currentUser.displayName || "User",
        userPhoto: currentUser.photoURL || "",
        updatedAt: Date.now()
      };
      await set(reviewRef, payload);
      toast("Ulasan tersimpan!");
    }

    function lockBodyScroll(lock){
      document.body.style.overflow = lock ? "hidden" : "";
    }

    function openDetail(id){
      const a = allApps.find(x=>x.id===id);
      if (!a){
        toast("Item tidak ditemukan.");
        return;
      }
      currentAppId = id;

      const url = new URL(location.href);
      url.searchParams.set("id", id);
      history.replaceState({}, "", url);

      const stats = computeReviewStats(a.reviews);
      modalTitle.textContent = a.name;

      const badges = [
        isNew(a.updatedAt) ? `<span class="badge new">NEW</span>` : ``,
        a.mod ? `<span class="badge mod">MOD</span>` : ``
      ].filter(Boolean).join("");

      const shotsHtml = (a.screenshots && a.screenshots.length)
        ? `<div class="panel">
            <div class="panelHead"><h3>Screenshots</h3></div>
            <div class="shots">
              ${a.screenshots.map(s => `
                <img class="shot" src="${s}" alt="screenshot" onerror="this.style.display='none'">
              `).join("")}
            </div>
          </div>`
        : "";

      const dist = stats.dist;
      const total = Math.max(1, stats.count);

      modalBody.innerHTML = `
        <div class="hero">
          <img class="ico" src="${a.icon || "icon/default.png"}" alt="${escapeHtml(a.name)}" onerror="this.src='icon/default.png'">
          <div style="min-width:0">
            <h2>${escapeHtml(a.name)}</h2>
            <div class="heroSmall">
              <span>${starsDisplay(stats.avg)}</span>
              <span class="ratingNum">${stats.avg ? stats.avg.toFixed(1) : "0.0"}</span>
              <span>(${stats.count} ulasan)</span>
              <span style="opacity:.6">•</span>
              <span>${escapeHtml(a.category || "Lainnya")}</span>
              <span style="opacity:.6">•</span>
              <span>Update ${fmtDate(a.updatedAt)}</span>
              ${badges}
            </div>

            <div class="actions">
              <a class="btn primary" href="${a.downloadUrl || "#"}" target="_blank" rel="noopener" ${a.downloadUrl ? "" : "onclick='return false;'"}>
                ⬇ Install
              </a>
              <button class="btn" id="copyLinkBtn" type="button">Copy Link</button>
              <button class="btn" id="shareBtn" type="button">Share</button>
            </div>
          </div>
        </div>

        <div class="kv">
          <div class="box"><div class="k">Type</div><div class="v">${typeOfApp(a)==="games" ? "Game" : "Aplikasi"}</div></div>
          <div class="box"><div class="k">Version</div><div class="v">${escapeHtml(a.version || "-")}</div></div>
          <div class="box"><div class="k">Size</div><div class="v">${escapeHtml(a.size || "-")}</div></div>
          <div class="box"><div class="k">Downloads</div><div class="v">${fmtNum(a.downloads)}</div></div>
        </div>

        <div class="panel" id="reviewPanel">
          <div class="panelHead">
            <h3>Ratings & reviews</h3>
            <div class="reviewSummary">
              <span>${starsDisplay(stats.avg)}</span>
              <span class="ratingNum" id="avgNum">${stats.avg ? stats.avg.toFixed(1) : "0.0"}</span>
              <span id="reviewCount">(${stats.count})</span>
            </div>
          </div>

          <div class="reviewGrid">
            <div class="reviewStats">
              <div class="bigRating">
                <div class="num">${stats.avg ? stats.avg.toFixed(1) : "0.0"}</div>
                <div>${starsDisplay(stats.avg)}</div>
                <div class="hint">${stats.count} ulasan</div>
              </div>

              <div class="bars">
                ${[5,4,3,2,1].map(s=>{
                  const c = dist[s-1] || 0;
                  const pct = Math.round((c/total)*100);
                  return `
                    <div class="barRow">
                      <div>${s}</div>
                      <div class="bar"><span style="width:${pct}%"></span></div>
                      <div>${pct}%</div>
                    </div>
                  `;
                }).join("")}
              </div>
            </div>

            <div>
              <div class="rateStars" id="rateStars"></div>
              <div class="hint" id="selectedLabel" style="margin-top:2px">Belum memilih rating</div>

              <textarea id="commentBox" placeholder="Tulis ulasan kamu (opsional)..."></textarea>

              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px">
                <div class="hint" id="reviewHint">Pilih bintang, tulis ulasan, lalu klik Kirim.</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                  <button class="btn" id="reviewLoginBtn" style="display:none" type="button">Login untuk Ulasan</button>
                  <button class="btn primary" id="submitReviewBtn" type="button">Kirim</button>
                </div>
              </div>

              <div class="hint" style="margin-top:8px">
                1 akun Google = 1 ulasan. Bisa <b>Perbarui</b> kapan saja.
                <span id="charInfo" class="hint"></span>
              </div>
            </div>
          </div>

          <div class="reviewsList" id="reviewsList"></div>
        </div>

        <div class="panel">
          <div class="panelHead"><h3>Deskripsi</h3></div>
          <p>${escapeHtml(a.description || "-")}</p>
        </div>

        ${a.changelog ? `
          <div class="panel">
            <div class="panelHead"><h3>Changelog</h3></div>
            <p>${escapeHtml(a.changelog)}</p>
          </div>
        ` : ""}

        ${shotsHtml}
      `;

      const shareUrl = location.href;
      document.getElementById("copyLinkBtn").onclick = async ()=>{
        try{
          await navigator.clipboard.writeText(shareUrl);
          toast("Link berhasil di-copy!");
        } catch {
          toast("Gagal copy. Coba manual.");
        }
      };
      document.getElementById("shareBtn").onclick = async ()=>{
        if (navigator.share){
          try{
            await navigator.share({ title: a.name, text: "Install dari APK Store", url: shareUrl });
          } catch {}
        } else toast("Browser belum support Share. Pakai Copy Link.");
      };

      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      lockBodyScroll(true);

      setupReviewUI(id);
      renderReviewsList(id);
    }

    function closeDetail(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      lockBodyScroll(false);
      const url = new URL(location.href);
      url.searchParams.delete("id");
      history.replaceState({}, "", url);
      currentAppId = null;
    }
    closeBtn.onclick = closeDetail;
    overlay.addEventListener("click",(e)=>{ if (e.target===overlay) closeDetail(); });
    window.addEventListener("keydown",(e)=>{ if (e.key==="Escape") closeDetail(); });

    // ===== Review UI (interactive) =====
    let _reviewFormCache = null;

    function setupReviewUI(appId){
      const rateStarsEl = document.getElementById("rateStars");
      const commentBox = document.getElementById("commentBox");
      const submitBtn = document.getElementById("submitReviewBtn");
      const loginReviewBtn = document.getElementById("reviewLoginBtn");
      const hintEl = document.getElementById("reviewHint");
      const charInfo = document.getElementById("charInfo");
      const selectedLabel = document.getElementById("selectedLabel");

      let selectedStars = 0;
      const MAX_LEN = 500;

      function updateSelectedLabel(){
        selectedLabel.textContent = selectedStars ? `Rating dipilih: ${selectedStars}/5` : "Belum memilih rating";
      }
      function updateCharInfo(){
        const len = (commentBox.value || "").length;
        charInfo.textContent = ` • ${len}/${MAX_LEN}`;
        if (len > MAX_LEN){
          charInfo.classList.add("danger");
          charInfo.textContent = ` • ${len}/${MAX_LEN} (kepanjangan)`;
        } else charInfo.classList.remove("danger");
      }
      function renderStars(){
        rateStarsEl.innerHTML = "";
        for (let i=1;i<=5;i++){
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "starBtn";
          btn.innerHTML = starSvg(i <= selectedStars);
          btn.onpointerdown = (e)=>{
            e.preventDefault();
            selectedStars = i;
            renderStars();
            updateSelectedLabel();
          };
          rateStarsEl.appendChild(btn);
        }
      }

      async function loadMyExistingReview(){
        if (!currentUser){
          selectedStars = 0;
          commentBox.value = "";
          submitBtn.textContent = "Kirim";
          hintEl.textContent = "Login untuk memberi ulasan.";
          loginReviewBtn.style.display = "inline-flex";
          renderStars(); updateSelectedLabel(); updateCharInfo();
          return;
        }
        loginReviewBtn.style.display = "none";
        hintEl.textContent = "Pilih bintang, tulis ulasan, lalu klik Kirim.";

        const mine = await getMyReview(appId);
        if (mine){
          selectedStars = Number(mine.stars || 0);
          commentBox.value = String(mine.comment || "");
          submitBtn.textContent = "Perbarui";
          hintEl.textContent = `Ulasan kamu terakhir diupdate: ${timeAgo(mine.updatedAt)}`;
        } else {
          selectedStars = 0;
          commentBox.value = "";
          submitBtn.textContent = "Kirim";
        }
        renderStars(); updateSelectedLabel(); updateCharInfo();
      }

      loginReviewBtn.onclick = async ()=>{
        try{
          await signInWithPopup(auth, provider);
          toast("Login berhasil!");
          await loadMyExistingReview();
        } catch (e){
          toast("Login gagal. Cek Authorized domains.");
          console.error(e);
        }
      };
      commentBox.addEventListener("input", updateCharInfo);

      submitBtn.onclick = async ()=>{
        if (!currentUser){
          toast("Login dulu untuk ulasan.");
          loginReviewBtn.style.display = "inline-flex";
          return;
        }
        if (selectedStars < 1 || selectedStars > 5){
          toast("Pilih rating 1–5 bintang dulu (klik bintangnya).");
          return;
        }
        const comment = (commentBox.value || "").trim();
        if (comment.length > MAX_LEN){
          toast("Komentar terlalu panjang (max 500).");
          return;
        }

        try{
          await submitReview(appId, selectedStars, comment);
          submitBtn.textContent = "Perbarui";
          hintEl.textContent = "Ulasan tersimpan. Kamu bisa perbarui kapan saja.";
          renderReviewsList(appId);
        } catch (e){
          toast("Gagal menyimpan ulasan.");
          console.error(e);
        }
      };

      renderStars(); updateSelectedLabel(); updateCharInfo();
      loadMyExistingReview();

      _reviewFormCache = { appId, reload: loadMyExistingReview };
    }

    async function refreshReviewForm(appId){
      if (_reviewFormCache && _reviewFormCache.appId === appId){
        await _reviewFormCache.reload();
      }
    }

    function renderReviewsList(appId){
      const a = allApps.find(x=>x.id===appId);
      if (!a) return;

      const list = document.getElementById("reviewsList");
      const avgNum = document.getElementById("avgNum");
      const reviewCount = document.getElementById("reviewCount");
      if (!list || !avgNum || !reviewCount) return;

      const reviewsObj = a.reviews || {};
      const entries = Object.entries(reviewsObj)
        .map(([uid,v])=>({
          uid,
          stars: Number(v?.stars || 0),
          comment: String(v?.comment || ""),
          userName: String(v?.userName || "User"),
          userPhoto: String(v?.userPhoto || ""),
          updatedAt: Number(v?.updatedAt || 0)
        }))
        .filter(r=>r.stars>=1 && r.stars<=5)
        .sort((x,y)=>(y.updatedAt||0)-(x.updatedAt||0));

      const stats = computeReviewStats(reviewsObj);
      avgNum.textContent = stats.avg ? stats.avg.toFixed(1) : "0.0";
      reviewCount.textContent = `(${stats.count})`;

      list.innerHTML = "";
      if (entries.length === 0){
        list.innerHTML = `<div class="hint">Belum ada ulasan. Jadilah yang pertama!</div>`;
        return;
      }

      entries.slice(0, 30).forEach(r=>{
        const div = document.createElement("div");
        div.className = "reviewItem";
        div.innerHTML = `
          <img class="rAvatar" src="${r.userPhoto || "icon/default.png"}" alt="avatar" onerror="this.src='icon/default.png'">
          <div class="rMain">
            <div class="rTop">
              <div style="display:flex;gap:8px;align-items:center;min-width:0;flex-wrap:wrap">
                <div class="rName" title="${escapeHtml(r.userName)}">${escapeHtml(r.userName)}</div>
                <div>${starsDisplay(r.stars)}</div>
              </div>
              <div class="rTime">${r.updatedAt ? timeAgo(r.updatedAt) : ""}</div>
            </div>
            ${r.comment ? `<div class="rComment">${escapeHtml(r.comment)}</div>` : `<div class="hint" style="margin-top:6px">(Tanpa komentar)</div>`}
          </div>
        `;
        list.appendChild(div);
      });
    }

    // ====== Realtime load ======
    const appsRef = ref(db, "apps");
    onValue(appsRef, (snapshot)=>{
      allApps = normalizeApps(snapshot.val());
      renderSubcats();
      render();

      if (currentAppId){
        renderReviewsList(currentAppId);
      }
    }, (err)=>{
      contentEl.innerHTML = `<div class="state">Gagal load data. Cek Rules / koneksi internet.<br><br><b>${escapeHtml(safeText(err?.message,""))}</b></div>`;
      console.error(err);
    });

    // init UI
    setActiveTabs();
    setActiveNav();
  </script>
</body>
</html>
